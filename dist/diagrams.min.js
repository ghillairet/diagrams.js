(function(t){"use strict";function e(t){return t.figure&&"text"===t.figure.type}function i(t,e){this.connection=t,this.paper=t.renderer(),this.x=e.x,this.y=e.y}function r(t,e,i){for(var r=["M",t.x,t.y],s=0,n=i.length;n>s;s++)r.push("L",i[s].x,i[s].y);return r.push("L",e.x,e.y),r}var s={version:"0.1.0"};t.Ds=s;var n=function(t){return _.isNumber(t)&&_.isFinite(t)?t>0:!1};Raphael.el.is=function(t){return this.type===t},Raphael.el.x=function(){switch(this.type){case"ellipse":case"circle":return this.attr("cx");default:return this.attr("x")}},Raphael.el.y=function(){switch(this.type){case"ellipse":case"circle":return this.attr("cy");default:return this.attr("y")}},Raphael.el.o=function(){var t=this.attr();return this.oa=_.clone(t),this.oa.fill=this.attr("fill"),void 0===this.oa["fill-opacity"]&&(this.oa["fill-opacity"]=1),this.ox=this.x(),this.oy=this.y(),this.ow=t.width,this.oh=t.height,this.or=t.r,this.orx=t.rx,this.ory=t.ry,this},Raphael.el.reset=function(){var t=this.oa;return t?(t.width=this.attrs.width,t.height=this.attrs.height,t.r=this.attrs.r,t.cx=this.attrs.cx,t.cy=this.attrs.cy,t.x=this.attrs.x,t.y=this.attrs.y,this.attr(t),delete this.oa,this):this},Raphael.el.getABox=function(){var t=this.getBBox(),e={x:t.x,y:t.y,width:t.width,height:t.height,xLeft:t.x,xCenter:t.x+t.width/2,xRight:t.x+t.width,yTop:t.y,yMiddle:t.y+t.height/2,yBottom:t.y+t.height};return e.center={x:e.xCenter,y:e.yMiddle},e.topLeft={x:e.xLeft,y:e.yTop},e.topRight={x:e.xRight,y:e.yTop},e.bottomLeft={x:e.xLeft,y:e.yBottom},e.bottomRight={x:e.xRight,y:e.yBottom},e.top={x:e.xCenter,y:e.yTop},e.bottom={x:e.xCenter,y:e.yBottom},e.left={x:e.xLeft,y:e.yMiddle},e.right={x:e.xRight,y:e.yMiddle},e},Raphael.fn.polyline=function(t,e){for(var i=["M",t,e,"L"],r=2;arguments.length>r;r++)i.push(arguments[r]);return this.path(i.join(" "))},Raphael.fn.triangle=function(t,e,i){var r=["M",t,e];return r=r.concat(["L",t+i/2,e+i]),r=r.concat(["L",t-i/2,e+i]),this.path(r.concat(["z"]).join(" "))},s.Styles={moveStyle:{fill:"grey","fill-opacity":.2,"stroke-width":0},resizeStyle:{fill:"grey","fill-opacity":.2,"stroke-width":0},selectStyle:{fill:"none",stroke:"black","stroke-width":1},anchorStyle:{fill:"black",stroke:"none","fill-opacity":1}};var h=s.Point=function h(t,e){!e&&_.isObject(t)?(this.x=t.x,this.y=t.y):(this.x=t,this.y=e)};h.prototype.isInside=function(t){return t&&t.x?this.x>=t.x&&this.x<=t.xRight&&this.y>=t.y&&this.y<=t.yBottom:!1},h.prototype.theta=function(t){return h.theta(this,t)},h.prototype.vector=function(t){return h.vector(this,t)},h.prototype.add=function(t){this.x+=t.y,this.y+=t.y},h.prototype.sub=function(t){this.x-=t.x,this.y-=t.y},h.prototype.equals=function(t){return this.x===t.x&&this.y===t.y},h.theta=function(t,e){var i=-(e.y-t.y),r=e.x-t.x,s=Math.atan2(i,r);return 0>s&&(s=2*Math.PI+s),{degrees:180*s/Math.PI,radians:s}},h.vector=function(t,e){return{x:e.x-t.x,y:e.y-t.y}},h.get=function(t,e){if(window.event&&void 0!==window.event.contentOverflow)return new h(window.event.x,window.event.y);if(void 0!==e.offsetX&&void 0!==e.offsetY)return new h(e.offsetX,e.offsetY);var i=t.paper?t.paper():t;e.pageX,e.pageY;for(var r=i.canvas.parentNode,s=0,n=0;r&&!isNaN(r.offsetLeft)&&!isNaN(r.offsetTop);)s+=r.offsetLeft-r.scrollLeft,n+=r.offsetTop-r.scrollTop,r=r.offsetParent;return s=e.pageX-s,n=e.pageY-n,new h(s,n)};var o=function(t,e,i){return this.paper=t,this.start=e,this.end=i,this.wrapper=t.path("M"+this.start.x+","+this.start.y+"L"+this.end.x+","+this.end.y),this};o.prototype.attr=function(){return Raphael.el.attr.apply(this.wrapper,arguments)},o.prototype.remove=function(){this.wrapper.remove()},o.prototype.intersection=function(t){var e={x:this.end.x-this.start.x,y:this.end.y-this.start.y},i={x:t.end.x-t.start.x,y:t.end.y-t.start.y},r=e.x*i.y-e.y*i.x,s={x:t.start.x-this.start.x,y:t.start.y-this.start.y},n=s.x*i.y-s.y*i.x,h=s.x*e.y-s.y*e.x;if(0===r||0>n*r||0>h*r)return null;if(r>0){if(n>r||h>r)return null}else if(r>n||r>h)return null;return{x:this.start.x+n*e.x/r,y:this.start.y+n*e.y/r}},o.prototype.findIntersection=function(t){for(var e=[{p1:t.topLeft,p2:t.topRight},{p1:t.topLeft,p2:t.bottomLeft},{p1:t.bottomLeft,p2:t.bottomRight},{p1:t.bottomRight,p2:t.topRight}],i=0;e.length>i;i++){var r=new o(this.paper,e[i].p1,e[i].p2),s=this.intersection(r);if(r.remove(),s)return s}return null};var a=/\s+/;s.Events={on:function(t,e,i){var r,s,n;if(!e)return this;for(t=t.split(a),r=this._callbacks||(this._callbacks={});s=t.shift();)n=r[s]||(r[s]=[]),n.push(e,i);return this},off:function(t,e,i){var r,s,n,h;if(!(s=this._callbacks))return this;if(!(t||e||i))return delete this._callbacks,this;for(t=t?t.split(a):_.keys(s);r=t.shift();)if((n=s[r])&&(e||i))for(h=n.length-2;h>=0;h-=2)e&&n[h]!==e||i&&n[h+1]!==i||n.splice(h,2);else delete s[r];return this},trigger:function(t){var e,i,r,s,n,h,o,u;if(!(i=this._callbacks))return this;for(u=[],t=t.split(a),s=1,n=arguments.length;n>s;s++)u[s-1]=arguments[s];for(;e=t.shift();){if((o=i.all)&&(o=o.slice()),(r=i[e])&&(r=r.slice()),r)for(s=0,n=r.length;n>s;s+=2)r[s].apply(r[s+1]||this,u);if(o)for(h=[e].concat(u),s=0,n=o.length;n>s;s+=2)o[s].apply(o[s+1]||this,h)}return this}};var u=s.Element=function(){this.attributes={}},c=function(t,e){return l(this,t,e)},p=function(){},l=function(t,e,i){var r;return r=e&&e.hasOwnProperty("constructor")?e.constructor:function(){t.apply(this,arguments)},_.extend(r,t),p.prototype=t.prototype,r.prototype=new p,e&&_.extend(r.prototype,e),i&&_.extend(r,i),r.prototype.constructor=r,r.__super__=t.prototype,r};u.extend=c,u.prototype={initialize:function(){},has:function(t){return null!=this.attributes[t]},get:function(t){return this.attributes[t]},set:function(t,e){var i;_.isObject(t)?i=t:(i={})[t]=e;for(var r in i)this.attributes[r]=i[r];return this},toJSON:function(){var t=this.attributes,e=_.clone(t);return this._deepClone(e)},_deepClone:function(t){for(var e in t){var i=t[e];if(_.isArray(i)){for(var r=[],s=0;i.length>s;s++){var n=i[s];n.attributes&&(r[s]=n.toJSON())}t[e]=r}else _.isObject(i)&&i.attributes&&(t[e]=i.toJSON())}return t}},_.extend(s.Element.prototype,s.Events);var d=Raphael._availableAttrs;d.text="";var g=s.Figure=s.Element.extend({constructor:function(t){t||(t={}),s.Element.apply(this,[t]),t.shape?this.shape=t.shape:t.paper&&(this.paper=t.paper),this.eveHandlers=[]},initialize:function(){},set:function(t,e){var i;_.isObject(t)?i=t:(i={})[t]=e;for(var r in i)this.setValue(r,i[r]);return this},setValue:function(t,e){_.has(this.defaults,t)&&(this.attributes[t]=e,this.setMinValues(t,e),this.wrapper&&this.wrapper.attr(t,e))},setMinValues:function(t,e){var i="min-"+t;("width"===t||"height"===t)&&(this.attributes[i]||(this.attributes[i]=e))},render:function(){},events:["click","dblclick","mouseover","mouseout","mouseup","mousedown","mousemove","touchmove","touchstart","touchend"],bindEvents:function(t){var e=this.shape,i=t||this.wrapper;this.eveHandlers=_.map(this.events,function(t){return{eve:t,handler:function(i){e.trigger(t,i)}}}),_.each(this.eveHandlers,function(t){i[t.eve](t.handler)})},unBindEvents:function(t){var e=t||this.wrapper;_.each(this.eveHandlers,function(t){e["un"+t.eve](t.handler)}),this.eveHandlers.length=0},renderer:function(){return this.shape.renderer()},startResize:function(t){this.wrapper&&(this.wrapper.o(),this.wrapper.attr(t))},resize:function(){},endResize:function(){this.wrapper&&this.wrapper.reset()},asDraggable:function(t){this.moveStyle=t,this.wrapper&&(this.wrapper.attr({cursor:"move"}),this.wrapper.drag(this.move,this.startMove,this.endMove))},startMove:function(){var t=this.control;if(t){var e=t.shape;e.connecting||(e.deselect(),e.removeContent(),_.clone(this.attrs),this.o(),this.attr(e.moveStyle),e.trigger("start:move"))}},move:function(t,e){var i=this.control||this;if(i){var r=i.shape;if(!r.connecting){var s=i.calculatePosition(t,e);i.set({x:s.x,y:s.y}),i.shape.renderEdges(),r.boundBox&&r.boundBox.render()}}},endMove:function(){var t=this.control;if(t){var e=t.shape;e.renderContent(),this.reset(),e.boundBox&&e.boundBox.remove(),e.renderEdges(),e.trigger("end:move")}},calculateX:function(t){var e=this.bounds(),i=this.limits(),r=this.wrapper.ox+t;return Math.min(Math.max(0,r),i.width-e.width)},calculateY:function(t){var e=this.bounds(),i=this.limits(),r=this.wrapper.oy+t;return Math.min(Math.max(0,r),i.height-e.height)},calculatePosition:function(t,e){return{x:this.calculateX(t),y:this.calculateY(e)}},bounds:function(){return this.wrapper?this.wrapper.getABox():{x:this.get("x"),y:this.get("y")}},limits:function(){if(this.shape,this.shape.parent)return this.shape.parent.bounds();var t=this.renderer();return{x:0,y:0,width:t.width,height:t.height}},remove:function(){return this.wrapper&&(this.wrapper.remove(),this.unBindEvents(),delete this.wrapper),this},translate:function(t,e){return this.wrapper&&(this.wrapper.transform("t"+t+","+e),this.attributes.x=this.wrapper.attr("x"),this.attributes.y=this.wrapper.attr("y")),this},isPointInside:function(t){var e=t.x,i=t.y,r=this.wrapper.getABox();return e>=r.x&&r.xRight>=e&&i>=r.y&&r.yBottom>=i},show:function(){this.wrapper&&this.wrapper.show()},hide:function(){this.wrapper&&this.wrapper.hide()},toFront:function(){this.wrapper&&this.wrapper.toFront()},toBack:function(){this.wrapper&&this.wrapper.toBack()},preferredSize:function(){return this.bounds()},minimumSize:function(){return this.bounds()},maximumSize:function(){return this.bounds()}},{defaults:{x:0,y:0,fill:"none",opacity:1,stroke:"none","fill-opacity":1,"stroke-opacity":1,"stroke-width":1,cursor:"default"},figures:{rect:"Rectangle",circle:"Circle",ellipse:"Ellipse",path:"Path",text:"Text"},create:function(t,e){if(t&&e){var i=e.type,r=g.figures[i],n={shape:t,figure:e};return i&&r?"function"==typeof r?new r(n):new s[r](n):void 0}}}),f=s.Rectangle=s.Figure.extend({constructor:function(t){t||(t={}),s.Figure.apply(this,[t]),this.defaults=_.extend({},f.defaults),this.attributes=_.extend({},this.defaults,t.figure||t),this.initialize(t)},bounds:function(){return this.wrapper?this.wrapper.getABox():{width:this.get("width"),height:this.get("height"),x:this.get("x"),y:this.get("y")}},render:function(){this.remove();var t=this.renderer();return this.wrapper=t.rect(this.get("x"),this.get("y"),this.get("width"),this.get("height"),this.get("r")),this.wrapper.attr(this.attributes),this.wrapper.control=this,this.bindEvents(),this},resize:function(t,e,i){var r=this.minimumSize(),s=this.limits(),n=this.wrapper.ox,h=this.wrapper.oy,o=this.wrapper.ow,a=this.wrapper.oh;"n"!==i&&"s"!==i&&(o=this.wrapper.ow+t),"w"!==i&&"e"!==i&&(a=this.wrapper.oh+e),_.include(["sw","nw","w"],i)&&(o=this.wrapper.ow-t,r.width>o&&(t-=r.width-o),n=this.wrapper.ox+t),_.include(["ne","nw","n"],i)&&(a=this.wrapper.oh-e,r.height>a&&(e-=r.height-a),h=this.wrapper.oy+e),r.height>a&&(a=r.height),r.width>o&&(o=r.width),o>s.width&&(o=s.width),a>s.height&&(a=s.height),s.x>n&&(n=s.x),s.y>h&&(h=s.y),this.set({width:o,height:a,y:h,x:n})},minimumSize:function(){return{width:this.get("min-width")||this.get("width"),height:this.get("min-height")||this.get("height")}}},{defaults:_.extend({},g.defaults,{width:0,height:0,r:0})}),m=s.Circle=s.Figure.extend({constructor:function(t){t||(t={}),s.Figure.apply(this,[t]),this.attributes=_.extend({},m.defaults,t.figure),this.defaults=m.defaults,this.initialize(t)},setValue:function(t,e){_.has(this.defaults,t)&&(this.attributes[t]=e,"x"===t||"y"===t?this.wrapper&&(this.wrapper.attr(t,e),this.layoutCircle()):(this.setMinValues(),this.circle&&(this.circle.attr(t,e),"r"===t&&this.layoutCircle())))},setMinValues:function(t,e){var i="min-"+t;"r"!==t||this.attributes[i]||(this.attributes[i]=e)},bounds:function(){return this.wrapper?this.wrapper.getABox():{width:this.get("width"),height:this.get("height"),r:this.get("r"),x:this.get("x"),y:this.get("y")}},layoutCircle:function(){var t=this.circle.getBBox();this.wrapper.attr({width:t.width,height:t.height,opacity:0,fill:"white"});var e=this.circle.attr("r"),i=this.wrapper.attr("x"),r=this.wrapper.attr("y");this.circle.attr({cx:i+e,cy:r+e})},render:function(){this.remove();var t=this.renderer();return this.wrapper=t.rect(this.get("x"),this.get("y")),this.circle=t.circle(0,0,this.get("r")),this.layoutCircle(),this.set(this.attributes),this.toFront(),this.wrapper.control=this,this.bindEvents(),this},remove:function(){return s.Figure.prototype.remove.apply(this),this.circle&&this.circle.remove(),this},resize:function(t,e,i){_.include(["ne","nw","n"],i)&&(e=-e);var r=this.minimumSize(),s=this.wrapper.or+(0>e?-1:1)*Math.sqrt(2*e*e),h=n(s)?s:this.wrapper.or;r.r>h&&(h=r.r),this.set({r:h})},minimumSize:function(){return{r:this.get("min-r")||this.get("r")}},translate:function(){return s.Figure.prototype.translate.apply(this,arguments),this.circle&&this.layoutCircle(),this},toFront:function(){this.wrapper&&(this.circle.toFront(),this.wrapper.toFront())},toBack:function(){this.wrapper&&(this.circle.toBack(),this.wrapper.toBack())}},{defaults:_.extend({},g.defaults,{r:0})}),w=s.Ellipse=s.Figure.extend({constructor:function(t){t||(t={}),s.Figure.apply(this,[t]),this.attributes=_.extend({},w.defaults,t.figure),this.defaults=w.defaults,this.initialize(t)},setValue:function(t,e){_.has(this.defaults,t)&&(this.attributes[t]=e,"x"===t||"y"===t?this.wrapper&&(this.wrapper.attr(t,e),this.layoutEllipse()):(this.setMinValues(),this.ellipse&&(this.ellipse.attr(t,e),("rx"===t||"ry"===t)&&this.layoutEllipse())))},setMinValues:function(t,e){var i="min-"+t;"rx"!==t&&"ry"!==t||this.attributes[i]||(this.attributes[i]=e)},layoutEllipse:function(){var t=this.ellipse.getBBox();this.wrapper.attr({width:t.width,height:t.height,opacity:0,fill:"white"});var e=this.ellipse.attr("rx"),i=this.ellipse.attr("ry"),r=this.wrapper.attr("x"),s=this.wrapper.attr("y");this.ellipse.attr({cx:r+e,cy:s+i})},render:function(){this.remove();var t=this.renderer();return this.wrapper=t.rect(this.get("x"),this.get("y")),this.ellipse=t.ellipse(),this.layoutEllipse(),this.set(this.attributes),this.wrapper.control=this,this.toFront(),this.bindEvents(),this},remove:function(){return s.Figure.prototype.remove.apply(this),this.ellipse&&this.ellipse.remove(),this},resize:function(t,e,i){_.include(["ne","nw","n"],i)&&(e=-e),_.include(["nw","sw","n"],i)&&(t=-t);var r=this.wrapper.orx+t,s=this.wrapper.orx+e;this.set({rx:n(r)?r:this.wrapper.orx,ry:n(s)?s:this.wrapper.ory})},bounds:function(){return this.wrapper?this.wrapper.getABox():{x:this.attributes.x,y:this.attributes.y,rx:this.attributes.rx,ry:this.attributes.ry}},translate:function(){return s.Figure.prototype.translate.apply(this,arguments),this.ellipse&&this.layoutEllipse(),this},toFront:function(){this.wrapper&&(this.ellipse.toFront(),this.wrapper.toFront())},toBack:function(){this.wrapper&&(this.ellipse.toBack(),this.wrapper.toBack())}},{defaults:_.extend({},g.defaults,{rx:0,ry:0})});s.Path=s.Figure.extend({constructor:function(t){t||(t={}),s.Figure.apply(this,[t]),this.attributes=_.extend({},t.figure),this.defaults=g.defaults,this.initialize(t)},setValue:function(t,e){_.has(this.defaults,t)&&(this.attributes[t]=e,"x"===t||"y"===t?this.wrapper&&(this.wrapper.attr(t,e),this.layoutPath()):this.path&&this.path.attr(t,e))},layoutPath:function(){var t=this.path.getBBox();this.path.ox===void 0&&(this.path.ox=t.x),this.path.oy===void 0&&(this.path.oy=t.y),this.wrapper.attr({width:t.width,height:t.height}),this.wrapper.getABox();var e=this.attributes.x-this.path.ox,i=this.attributes.y+this.path.oy;this.path.transform("t"+e+","+i)},render:function(){this.remove();var t=this.renderer();return this.wrapper=t.rect(this.get("x"),this.get("y")),this.wrapper.attr({opacity:0,fill:"white"}),this.path=t.path(this.get("path")),this.layoutPath(),this.toFront(),this.set(this.attributes),this.wrapper.control=this,this.bindEvents(),this},remove:function(){this.wrapper&&this.wrapper.remove(),this.path&&this.path.remove()},toFront:function(){this.path&&this.path.toFront(),this.wrapper&&this.wrapper.toFront()},toBack:function(){this.wrapper&&this.wrapper.toBack(),this.path&&this.path.toBack()},bounds:function(){return this.wrapper?this.wrapper.getABox():void 0},translate:function(t,e){return this.path.transform("t"+t+","+e),s.Figure.prototype.translate.apply(this,arguments)}},{defaults:_.extend({},g.defaults,{path:""})});var v=s.Text=s.Figure.extend({constructor:function(t){t||(t={});var e=t.figure||t;s.Figure.apply(this,[t]),this.defaults=_.extend({},v.defaults,v.textDefaults),this.attributes=_.extend({},v.defaults,_.object(_.filter(_.pairs(e),this.filterAttributes))),this.textAttributes=_.extend({},v.textDefaults,_.object(_.filter(_.pairs(e),this.filterTextAttributes))),this.position=v.getPosition(this,e),this.initialize(t)},filterAttributes:function(t){return _.has(v.defaults,t[0])},filterTextAttributes:function(t){return _.has(v.textDefaults,t[0])},get:function(t){return this.textAttributes[t]?this.textAttributes[t]:this.attributes[t]},setValue:function(t,e){_.has(this.textAttributes,t)?(this.textAttributes[t]=e,this.text&&this.text.attr(t,e)):(this.attributes[t]=e,this.wrapper&&(this.wrapper.attr(t,e),_.contains(["width","height","x","y"],t)&&this.layoutText()))},layoutText:function(){if(this.text){this.resizeBox();var t=this.bounds(),e=this.text,i=e.getABox();e.attr("y",t.yMiddle),"center"===this.position&&e.attr("x",t.xCenter),"left"===this.position&&e.attr("x",t.x+i.width/2),"right"===this.position&&e.attr("x",t.xRight-i.width/2)}},render:function(){this.remove();var t=this.renderer();return this.wrapper=t.rect(),this.text=t.text(0,0,this.textAttributes.text),this.text.attr(this.textAttributes),this.set({x:this.get("x"),y:this.get("y")}),this.wrapper.attr(this.attributes).attr({stroke:"none",fill:"white","fill-opacity":0}),this.layoutText(),this.toFront(),this.wrapper.control=this,this.bindEvents(),this},resizeBox:function(){var t=this.text.getBBox(),e=this.get("width"),i=this.get("height");t.width>e&&this.set("width",t.width),t.height>i&&this.set("height",t.height)},remove:function(){return this.wrapper&&(this.wrapper.remove(),this.text.remove(),this.unBindEvents(this.text),delete this.wrapper,delete this.text),this},minimumSize:function(){var t=this.text.getBBox();return{width:t.width,height:t.height}},toFront:function(){this.wrapper&&(this.text.toFront(),this.wrapper.toFront())},toBack:function(){this.wrapper&&(this.text.toBack(),this.wrapper.toBack())}},{textDefaults:{"font-size":12,text:"Label","font-weight":"normal","font-style":"normal","font-family":"Arial",fill:"black","fill-opacity":1,stroke:"none","stroke-opacity":1,"stroke-width":1},defaults:{width:0,height:0,x:0,y:0},positions:["center","left","right"],getPosition:function(t,e){var i=t.position||"center";return e&&e.position&&_.include(v.positions,e.position)&&(i=e.position),i}});s.DiagramElement=s.Element.extend({constructor:function(t){t||(t={}),s.Element.apply(this,[t]),this.id=t.id||_.uniqueId(),this.attributes.children=[],this.setFigure(t.figure||this.figure),this.set(t)},setFigure:function(t){this.figure=t instanceof g?t:g.create(this,t)},render:function(){return this},remove:function(){return this.figure&&this.figure.remove(),this},renderer:function(){var t=this.diagram;return t?t.renderer():this.parent?this.parent.renderer():null},get:function(t){return this.figure&&_.has(this.figure.defaults,t)?this.figure.get(t):u.prototype.get.apply(this,arguments)},set:function(t,e){var i;_.isObject(t)?i=t:(i={})[t]=e;for(var r in i)this.figure&&_.has(this.figure.defaults||{},r)?this.figure.set(r,i[r]):this.attributes[r]=i[r];return this},add:function(t){return t.setParent(this),this.get("children").push(t),this.trigger("add:children",t),this},setUpChildren:function(t){var i=function(t){e(t)?this.add(new D(t)):"function"==typeof t?this.add(new t):"object"==typeof t&&this.add(new L(t))};_.each(t,i,this)},setParent:function(t){return this.parent=t,this.setDiagram(t.diagram),this},setDiagram:function(t){this.diagram=t,_.each(this.get("children"),function(e){e.setDiagram(t)})},show:function(){return this.figure&&this.figure.show(),this},hide:function(){return this.figure&&this.figure.hide(),this},toFront:function(){return this.figure&&this.figure.toFront(),_.each(this.get("children"),function(t){t.toFront()}),this},toBack:function(){return _.each(this.get("children"),function(t){t.toBack()}),this.figure&&this.figure.toBack(),this},isPointInside:function(t){return this.figure?this.figure.isPointInside(t):!1},getByPoint:function(t){var e=[];return this.isPointInside(t)&&(e.push(this),e.push(_.map(this.get("children"),function(e){return e.getByPoint(t)}))),e}});var b=function(t,e){this.shape=t,this.type=e.type};b.extend=c,b.layouts=function(){return{xy:C,flow:k,grid:A,border:F}},b.create=function(t,e){var i,r,s=t.layout||e.layout,n=s?s.type:null;return _.has(b.layouts(),n)&&(r=b.layouts()[n],i=new r(t,s)),i},b.prototype={layout:function(){},minimumSize:function(){},maximumSize:function(){},preferredSize:function(){}},s.LayoutElement=s.DiagramElement.extend({constructor:function(t){s.DiagramElement.apply(this,[t]),t.gridData&&(this.gridData=t.gridData),this.initialize(t)},bounds:function(){return this.figure?this.figure.bounds():{x:this.get("x"),y:this.get("y"),width:this.get("width"),height:this.get("height")}},preferredSize:function(){return this.layout?this.layout.preferredSize():this.figure.preferredSize()},minimumSize:function(){return this.layout?this.layout.minimumSize():this.figure.minimumSize()},maximumSize:function(){return this.layout?this.layout.maximumSize():this.figure.maximumSize()},doLayout:function(){this.layout&&(this.layout.layout(),this.renderEdges())}}),s.Diagram=s.DiagramElement.extend({constructor:function(t){t||(t={}),s.DiagramElement.apply(this,[t]),this.attributes.selection=[],this.attributes.currentSource=null,this.attributes.currentEdge=null,this.attributes.isSelecting=!1,this.attributes.isDragging=!1,this.attributes.children=[],this.attributes.edges=[],t.el&&(this.el=t.el),this.el&&this.setElement(this.el),this.setFigure(this.figure),this.initialize(t)},figure:{type:"rect",fill:"white",opacity:0,stroke:"none"},renderer:function(){return this._paper||this._initPaper(),this._paper},setElement:function(t){if(!t)return this;if(_.isString(t)){var e=0===t.indexOf("#")?t.slice(1,t.length):t;this.el=document.getElementById(e)}else t instanceof HTMLElement&&(this.el=t);return this},canvas:function(){return this._paper?this._paper.canvas:null},render:function(){var t=this.renderer(),e=t.canvas,i=e.clientLeft,r=e.clientTop,s=e.width.baseVal.value,n=e.height.baseVal.value;return this.set({x:i,y:r,width:s,height:n}),this.figure.render(),_.each(this.attributes.children,function(t){t.render()}),_.each(this.attributes.edges,function(t){t.render()}),this.on("touchstart mousedown",this.changeViewBox),this.on("touchstart mousedown",this.selectGroup),this.on("touchstart click",this.deselect,this),this},setViewBox:function(t,e,i,r){var s=t||0,n=e||0,h=i||this._paper.width,o=r||this._paper.height;this._paper&&this._paper.setViewBox&&this._paper.setViewBox(s,n,h,o)},zoom:function(t){var e=this.get("x"),i=this.get("y"),r=this.renderer(),s=this._paper.width=r.width+t,n=this._paper.height=r.height+t;this.setViewBox(e,i,s+t,n+t)},remove:function(){this._paper&&(_.each(this.attributes.children,function(t){t.remove()}),_.each(this.attributes.edges,function(t){t.remove()}),this._paper.remove(),this._paper=null)},changeViewBox:function(t){if(this.get("isDragging")){var e,i=h.get(this,t);this.toFront();var r=function(t){var r=new h(this.get("x"),this.get("y"));t.stopImmediatePropagation(),e=h.get(this,t),r.sub(i.vector(e)),this.set(r),this.setViewBox(r.x,r.y),i=e},s=function(t){t.stopImmediatePropagation(),this.toBack(),this.off("mouseup touchend touchcancel",s),this.off("mousemove touchmove",r)};this.on("mouseup touchend touchcancel",s),this.on("mousemove touchmove",r)}},selectGroup:function(t){if(this.get("isSelecting")){var e,i,r,s,n,o,a,u,c=h.get(this,t),p=this.renderer().rect(c.x,c.y,0,0);p.attr({"fill-opacity":.15,"stroke-opacity":.5,fill:"#007fff",stroke:"#007fff"}),this.wrapper.toFront();var l=function(t){t.stopImmediatePropagation(),e=h.get(this,t),i=p.getABox(),r=e.x-c.x,s=e.y-c.y,n=p.attr("width"),a=p.attr("height"),o=n+r,u=a+s,i.x<=e.x?i.xRight>e.x&&r>0&&(p.attr("x",e.x),o=n-r):(p.attr("x",e.x),o=n-r),(i.y>e.y||s>0&&i.yBottom>e.y)&&(p.attr("y",e.y),u=a-s),o>=0&&u>=0&&p.attr({width:o,height:u}),c=e},d=function(t){t.stopImmediatePropagation(),this.wrapper.toBack(),this.isSelecting=!1,this.off("mouseup touchend touchcancel",d),this.off("mousemove touchmove",l),p.remove()};this.on("mouseup touchend touchcancel",d),this.on("mousemove touchmove",l)}},add:function(){if(!arguments.length)return this;var t=function(t,e){t.id&&!e.getShape(t.id)&&(e.get("children").push(t),t.setDiagram(e),e.trigger("add:children",t))},e=function(t,e){t.id&&!e.getConnection(t.id)&&(e.get("edges").push(t),t.setDiagram(e),e.trigger("add:connection",t))};return _.each(arguments,function(i){i instanceof s.Shape?t(i,this):i instanceof s.Label?t(i,this):i instanceof s.Connection&&e(i,this)},this),this},removeShape:function(t){if(t){var e=this.get("children"),i=function(e){return e===t};this.set("children",_.reject(e,i)),this.trigger("remove:children",t)}},getShape:function(t){if(!t)return null;var e=function(e){return e.id===t};return _.find(this.get("children"),e)},getShapesByPoint:function(t){var e=arguments;if(!t)return null;if(2===e.length&&(t={x:e[0],y:e[1]}),isNaN(t.x)||isNaN(t.y))return[];var i=function(e){return e.getByPoint(t)};return _.flatten(_.map(this.get("children"),i))},getShapesByBox:function(t){if(!t||!t.x)return[];var e,i=function(i){return e=i.bounds(),t.x<=e.x&&t.xRight>=e.x&&t.y<=e.y&&t.yBottom>=e.y};return _.filter(this.get("children"),i)},removeConnection:function(t){if(t){var e=this.edges,i=function(e){return e===t};this.set("edges",_.reject(e,i)),this.trigger("remove:edges",t)}},getConnection:function(t){if(!t)return null;var e=function(e){return e.id===t};return _.find(this.get("edges"),e)},deselect:function(t){var e=this.get("selection");this.isSelectable(t)?(t.deselect(),this.set("selection",_.without(e,t))):(_.each(e,function(t){t.deselect()}),e.length=0)},setSelection:function(t){return this.isSelectable(t)&&(this.deselect(),this.get("selection").push(t),this.trigger("select",t)),this},addSelection:function(t){return this.isSelectable(t)&&this.get("selection").push(t),this},isSelectable:function(t){return t&&"function"==typeof t.deselect},getSelection:function(){return this.get("selection")},_initPaper:function(){if(!this._paper){if(!this.el)throw Error("Diagram element is missing, use setElement()");this._paper=Raphael(this.el,this.width,this.height),this.setViewBox(0,0,this._paper.width,this._paper.height)}},toFront:function(){this.figure.toFront()},toBack:function(){this.figure.toBack()}});var B=s.ToolBox=s.DiagramElement.extend({constructor:function(t){s.DiagramElement.apply(this,[t]),this.element=t.element,this.width=70,this.height=60},render:function(){if(this.element||this.element.wrapper){this.wrapper&&this.wrapper.remove();var t=this.element.renderer(),e=this.element.wrapper.getABox(),i=e.xRight-40,r=e.y-30;this.wrapper=t.rect(i,r,this.width,this.height,6).attr({fill:"orange","fill-opacity":0,stroke:"black","stroke-opacity":0,"stroke-width":2}).toBack(),this.wrapper.controller=this,this.wrapper.mouseover(this.handleMouseOver),this.wrapper.mouseout(this.handleMouseOut),e=this.wrapper.getABox();var s=this;return this.addItem(e.xLeft+20,e.y,z,function(){s.element.remove(!0)}),this}},addItem:function(t,e,i,r){var s=this,n=this.element.renderer(),h=n.path(i);return h.attr({fill:"#000",stroke:"none"}),h.attr({cursor:"pointer"}),h.translate(t,e),h.scale(.8,.8),this.get("children").push(h),h.mouseover(function(){s.isOverChild=!0}),h.mouseout(function(t){t.stopPropagation(),s.isOverChild=!1}),h.click(r),this},remove:function(){this.wrapper&&(this.wrapper.remove(),_.each(this.get("children"),function(t){t.remove()}),this.get("children").length=0)},handleMouseOver:function(){this.controller.isOver=!0},handleMouseOut:function(t){t.stopPropagation()}}),z="M20.826,5.75l0.396,1.188c1.54,0.575,2.589,1.44,2.589,2.626c0,2.405-4.308,3.498-8.312,3.498c-4.003,0-8.311-1.093-8.311-3.498c0-1.272,1.21-2.174,2.938-2.746l0.388-1.165c-2.443,0.648-4.327,1.876-4.327,3.91v2.264c0,1.224,0.685,2.155,1.759,2.845l0.396,9.265c0,1.381,3.274,2.5,7.312,2.5c4.038,0,7.313-1.119,7.313-2.5l0.405-9.493c0.885-0.664,1.438-1.521,1.438-2.617V9.562C24.812,7.625,23.101,6.42,20.826,5.75zM11.093,24.127c-0.476-0.286-1.022-0.846-1.166-1.237c-1.007-2.76-0.73-4.921-0.529-7.509c0.747,0.28,1.58,0.491,2.45,0.642c-0.216,2.658-0.43,4.923,0.003,7.828C11.916,24.278,11.567,24.411,11.093,24.127zM17.219,24.329c-0.019,0.445-0.691,0.856-1.517,0.856c-0.828,0-1.498-0.413-1.517-0.858c-0.126-2.996-0.032-5.322,0.068-8.039c0.418,0.022,0.835,0.037,1.246,0.037c0.543,0,1.097-0.02,1.651-0.059C17.251,18.994,17.346,21.325,17.219,24.329zM21.476,22.892c-0.143,0.392-0.69,0.95-1.165,1.235c-0.474,0.284-0.817,0.151-0.754-0.276c0.437-2.93,0.214-5.209-0.005-7.897c0.881-0.174,1.708-0.417,2.44-0.731C22.194,17.883,22.503,20.076,21.476,22.892zM11.338,9.512c0.525,0.173,1.092-0.109,1.268-0.633h-0.002l0.771-2.316h4.56l0.771,2.316c0.14,0.419,0.53,0.685,0.949,0.685c0.104,0,0.211-0.017,0.316-0.052c0.524-0.175,0.808-0.742,0.633-1.265l-1.002-3.001c-0.136-0.407-0.518-0.683-0.945-0.683h-6.002c-0.428,0-0.812,0.275-0.948,0.683l-1,2.999C10.532,8.77,10.815,9.337,11.338,9.512z",A=b.extend({constructor:function(t,e){e||(e={}),b.apply(this,[t,e]),this.columns=e.columns||1,this.rows=e.rows||0,this.marginHeight=e.marginHeight||0,this.marginWidth=e.marginWidth||0,this.vgap=e.vgap||0,this.hgap=e.hgap||0,this.columnsEqualWidth=e.columnsEqualWidth||!1},getRows:function(){var t=this.shape.attributes.children,e=this.columns||t.length;return this.rows>0?this.rows:Math.floor((t.length+e-1)/e)},getColumns:function(){var t=this.shape.attributes.children;return this.rows>0?Math.floor((t.length+this.rows-1)/this.rows):this.columns},layout:function(){this.shape.attributes.children&&this.shape.attributes.children.length&&_.each(this.computeRows("preferred"),function(t){_.each(t.cells,function(t){t.layout()})},this)},computeRows:function(t){var e,i=this.shape.bounds(),r=this.getColumns(),s=this.shape.attributes.children,n=[],h={width:0,height:0,cells:[]};n.push(h);for(var o=0,a=1;s.length>o;o++,a++){var u=s[o],c=new S({shape:u,grid:this});if(c.size=s[o][t+"Size"](),e&&(c.previous=e,e.next=c),e=c,u.gridData&&u.gridData instanceof E||(u.gridData=new E(u.gridData),u.gridData.grid=c.grid),h.cells.push(c),a>=r){if(o!=s.length-1){var p={previous:h,width:0,height:0,cells:[]};h.next=p,h=p,n.push(h)}a=0}}var l=this.marginWidth,d=this.marginHeight,g=function(){for(var t=[],e=0;r>e;e++){t.push([]);for(var i=0;n.length>i;i++){var s=n[i].cells[e];s&&t[e].push(s)}}return t},f=function(t){var e=_.reduce(t,function(t,e){return e.shape.gridData.grabExcessVerticalSpace?t:t+e.size.height},0),r=_.reduce(t,function(t,e){return e.shape.gridData.grabExcessVerticalSpace?t+1:t},0);return(i.height-2*d-e)/r},x=function(t){var e=_.reduce(t.cells,function(t,e){return e.shape.gridData.grabExcessHorizontalSpace?t:t+e.size.width},0),r=_.reduce(t.cells,function(t,e){return e.shape.gridData.grabExcessHorizontalSpace?t+1:t},0),s=(i.width-2*l-e)/r;return s},m=i.x+this.marginWidth,w=i.y+this.marginHeight,v=m;return _.each(g(),function(t){var e=f(t);_.each(t,function(t){t.height=t.shape.gridData.grabExcessVerticalSpace?e:t.size.height},this)},this),_.each(n,function(t){var e=x(t);_.each(t.cells,function(s){s.x=v,s.y=w,s.width=this.columnsEqualWidth?i.width/r:s.shape.gridData.grabExcessHorizontalSpace?e:s.size.width,t.width+=s.width,v+=s.width+this.hgap},this);var s=null;t.cells.length&&(s=_.max(t.cells,function(t){return t.height})),t.height=s?s.height:0,w+=t.height+this.vgap,v=m},this),n},size:function(t){var e=0,i=0,r=(this.shape.attributes.children,this.getColumns()),s=this.getRows(),n=this.shape.bounds(),h=this.computeRows(t),o=_.max(h,function(t){return t.width
});e=o?o.width:0,i=_.reduce(h,function(t,e){return t+e.height},0),e=e+(r-1)*this.hgap+2*this.marginWidth,i=i+(s-1)*this.vgap+2*this.marginHeight;var a=this.shape.figure.minimumSize();return e=Math.max(a.width,e),i=Math.max(a.height,i),n.width>e&&(e=n.width),n.height>i&&(i=n.height),{width:e,height:i}},preferredSize:function(){return this.size("preferred")},minimumSize:function(){return this.size("minimum")},maximumSize:function(){return this.size("maximum")}}),S=function(t){t||(t={}),this.shape=t.shape,this.grid=t.grid,this.x=t.x,this.y=t.y,this.width=this.grid.columnsEqualWidth?this.grid.columnWidth:this.shape.get("width"),this.height=this.shape.get("height")};S.prototype.layout=function(){this.shape.set(this.align()),this.shape.doLayout()},S.prototype.align=function(){var t=this.shape.gridData,e=t.horizontalAlignment,i=t.verticalAlignment,r=this.x,s=this.y,n=this.shape.get("width"),h=this.shape.get("height");return"fill"===e&&(n=this.width),"fill"===i&&(h=this.height),"center"===e&&(r=r+this.width/2-n/2),"center"===i&&(s=s+this.height/2-h/2),"end"===e&&(r=r+this.width-n),"end"===i&&(s=s+this.height-h),{x:r,y:s,width:n,height:h}};var E=s.GridData=function(t){t||(t={}),this.grid=t.grid,this.verticalAlignment=E.getVerticalAlignment(t),this.horizontalAlignment=E.getHorizontalAlignment(t),this.grabExcessVerticalSpace=t.grabExcessVerticalSpace||!1,this.grabExcessHorizontalSpace=t.grabExcessHorizontalSpace||!1,this.verticalSpan=t.verticalSpan||1,this.horizontalSpan=t.horizontalSpan||1};E.alignments=["center","fill","beginning","end"],E.getAlignment=function(t,e){var i=t[e+"Alignment"];return _.contains(E.alignments,i)?i:null},E.getVerticalAlignment=function(t){return E.getAlignment(t,"vertical")||"center"},E.getHorizontalAlignment=function(t){return E.getAlignment(t,"horizontal")||"beginning"};var k=b.extend({constructor:function(t,e){e||(e={}),b.apply(this,[t,e]),this.vertical=e.vertical},layout:function(){for(var t,e,i=this.shape.bounds(),r=this.shape.get("children"),s=0,n=r.length,h=0,o=0,a=i.x,u=i.y;n>s;s++)t=r[s],e=t.preferredSize(),h+e.width>i.width?(a=i.x,h+=e.width,u+=o,t.set({x:a,y:u})):(t.set({x:a,y:u}),o=Math.max(e.height,o),h+=e.width,a+=e.width)},size:function(t){for(var e,i,r=this.shape.bounds(),s=0,n=0,h=0,o=0,a=this.shape.get("children"),u=0,c=a.length;c>u;u++)e=a[u],i=e[t+"Size"](),0===u?(s=i.width||0,h=i.height||0):s+i.width>r.width?(o+=h,n=Math.max(n,s),s=i.width||0,h=i.height||0):(s+=i.width||0,h=Math.max(h,i.height||0));return o+=h,o=Math.max(r.height,o),n=Math.max(r.width,Math.max(n,s)),{width:n,height:o}},preferredSize:function(){return this.size("preferred")},minimumSize:function(){return this.size("minimum")},maximumSize:function(){return this.size("maximum")}}),C=b.extend({constructor:function(t,e){e||(e={}),b.apply(this,[t,e])},layout:function(){for(var t,e=this.shape,i=e.bounds(),r=e.attributes.children,s=r.length,n=0;s>n;n++)t=r[n],t.figure.translate(i.x,i.y),t.doLayout()},minimumSize:function(){return this.shape.figure.bounds()},preferredSize:function(){return this.shape.figure.bounds()},maximumSize:function(){return this.shape.figure.bounds()}}),F=b.extend({constructor:function(t,e){e||(e={}),b.apply(this,[t,e]),this.vgap=e.vgap||0,this.hgap=e.hgap||0},layout:function(){var t,e=this.shape.bounds(),i=e.y,r=e.bottomLeft.y,s=e.xLeft,n=e.xRight;this.north&&(t=this.north.preferredSize(),this.north.set({x:s,y:i,width:n-s,height:t.height}),this.north.doLayout(),i+=t.height+this.vgap),this.south&&(t=this.south.preferredSize(),this.south.set({x:s,y:r-t.height,width:n-s,height:t.height}),this.south.doLayout(),r-=t.height+this.vgap),this.east&&(t=this.east.preferredSize(),this.east.set({x:n-t.width,y:i,width:t.width,height:r-i}),this.east.doLayout(),n-=t.width+this.hgap),this.west&&(t=this.west.preferredSize(),this.west.set({x:s,y:i,width:t.width,height:r-i}),this.west.doLayout(),s+=t.width+this.hgap),this.center&&(this.center.set({x:s,y:i,width:n-s,height:r-i}),this.center.doLayout())},size:function(){return this.shape.bounds()}});s.BoundBox=s.DiagramElement.extend({constructor:function(t){s.DiagramElement.apply(this,[t]),this.control=t.control,this.control.on("start:move",this.stateMove,this),this.control.on("start:resize",this.stateSize,this),this.control.on("end:move end:resize",this.stateNone,this)},stateMove:function(){this.state="move",this._left="x",this._right="y"},stateSize:function(){this.state="resize",this._left="width",this._right="height"},stateNone:function(){delete this.state},render:function(){this.remove();var t=this.control.renderer(),e=this.control.bounds(),i=e.xRight+15,r=e.yMiddle;this.text=t.text(i,r,this.getText());var s=this.text.getABox().width;return this.text.translate(s/2+10,10),this.shadow=t.rect(i,r,s+20,20),this.shadow.attr({fill:"black",opacity:.2,stroke:"none"}),this.shadow.translate(2,2),this.wrapper=t.rect(i,r,s+20,20),this.wrapper.attr({fill:"#FFFF99",opacity:1,stroke:"none"}),this.text.toFront(),this},remove:function(){this.wrapper&&(this.wrapper.remove(),this.shadow.remove(),this.text.remove())},getText:function(){return this.getTemplate()({left:this.control.get(this._left),right:this.control.get(this._right)})},getTemplate:function(){return"move"===this.state?_.template("x: <%= left %>px y: <%= right %>px"):"resize"===this.state?_.template("width: <%= left %>px  height: <%= right %>px"):null}}),s.Selectable={anchors:["NorthAnchor","NorthEastAnchor","NorthWestAnchor","SouthAnchor","SouthEastAnchor","SouthWestAnchor","EastAnchor","WestAnchor"],createAnchor:function(t){return new s[t]({box:this}).render()},createSelectionBox:function(){var t=this.figure.bounds(),e=t.x,i=t.y,r=t.width,s=t.height;this.selectionBox=this.renderer().rect(e,i,r,s,0),this.selectionBox.attr(this.selectionStyle),this.selectionBox.toFront()},select:function(){this.figure&&(this.diagram.setSelection(this),this.createSelectionBox(),this.selectionAnchors=_.map(this.anchors,this.createAnchor,this))},deselect:function(){this._tool&&this._tool.remove(),this.selectionAnchors&&_.each(this.selectionAnchors,function(t){t.remove()}),this.selectionBox&&this.selectionBox.remove()}};var M=s.Anchor=s.DiagramElement.extend({cursor:"none",constructor:function(t){s.DiagramElement.apply(this,[t]),this.box=t.box,this.diagram=this.box.diagram,this.initialize.apply(this,arguments)},initialize:function(){},render:function(){var t=this.renderer();return this.wrapper=t.rect(this.x,this.y,6,6,0).attr(this.box.anchorStyle),this.box.resizable&&this.wrapper.attr({cursor:this.cursor}),this.wrapper.box=this.box,this.wrapper.anchor=this,this.box.resizable&&this.wrapper.drag(M.move,M.start,M.end),this},hide:function(){this.wrapper&&this.wrapper.hide()},remove:function(){if(this.wrapper&&this.wrapper.remove(),this.box){var t=this.box;this.box=null,t.anchor&&delete t.anchor}}});M.start=function(){var t=this.anchor,e=this.box;t.active=!0,this.o(),this.box.figure.wrapper.o(),e.startResize()},M.move=function(t,e){var i=this.box,r=this.anchor.direction;this.attr({x:this.ox+t,y:this.oy+e}),i.resize(t,e,r)},M.end=function(){var t=this.anchor,e=this.box;t.active=!1,e.endResize(),t.box.select()},s.NorthWestAnchor=M.extend({initialize:function(t){var e=t.box.figure.bounds();this.x=e.x-3,this.y=e.y-3,this.cursor="nw-resize",this.direction="nw"}}),s.SouthWestAnchor=M.extend({initialize:function(t){var e=t.box.figure.bounds();this.x=e.xLeft-3,this.y=e.yBottom-3,this.cursor="sw-resize",this.direction="sw"}}),s.NorthEastAnchor=M.extend({initialize:function(t){var e=t.box.figure.bounds();this.x=e.xRight-3,this.y=e.y-3,this.cursor="ne-resize",this.direction="ne"}}),s.SouthEastAnchor=M.extend({initialize:function(t){var e=t.box.figure.bounds();this.x=e.xRight-3,this.y=e.yBottom-3,this.cursor="se-resize",this.direction="se"}}),s.NorthAnchor=M.extend({initialize:function(t){var e=t.box.figure.bounds();this.x=e.xCenter-3,this.y=e.y-3,this.cursor="n-resize",this.direction="n"}}),s.SouthAnchor=M.extend({initialize:function(t){var e=t.box.figure.bounds();this.x=e.xCenter-3,this.y=e.yBottom-3,this.cursor="s-resize",this.direction="s"}}),s.WestAnchor=M.extend({initialize:function(t){var e=t.box.figure.bounds();this.x=e.x-3,this.y=e.yMiddle-3,this.cursor="w-resize",this.direction="w"}}),s.EastAnchor=M.extend({initialize:function(t){var e=t.box.figure.bounds();this.x=e.xRight-3,this.y=e.yMiddle-3,this.cursor="e-resize",this.direction="e"}}),s.Image=s.DiagramElement.extend({constructor:function(t){s.DiagramElement.apply(this,[t])},render:function(){var t=this.paper(),e=this.parent.wrapper.getBBox(),i=this.get("src"),r=this.get("width"),s=this.get("height");return this.wrapper=t.image(i,e.x,e.y,r,s),this.wrapper.toFront(),this.wrapper.controller=this,this},center:function(){var t=this.parent.wrapper.getABox();this.wrapper.attr({x:t.x-this.get("width")}),this.wrapper.attr({y:t.yMiddle-this.get("height")/2})}});var D=s.Label=s.LayoutElement.extend({resizable:!1,editable:!0,draggable:!0,constructor:function(t){t||(t={}),s.LayoutElement.apply(this,[t]),this.initProperties(t);var e=this.figure?this.figure.image:t.figure.image;e&&this.setImage(e),this.initialize(t)},initProperties:function(t){var e=["resizable","editable","draggable"],i=function(e){_.isBoolean(t[e])&&(this[e]=t[e])};_.each(e,i,this)},setImage:function(t){t.parent=this;var e=new s.Image(t);return this.image=e,e},render:function(){return this.figure.render(),this.figure.toFront(),this.image&&this.image.render(),this.editable&&this.asEditable(),this.draggable&&this.figure.asDraggable(),this},setText:function(t,e){this.set("text",t),this.doLayout(),e||this.trigger("change:text",this)},getText:function(){return this.get("text")},remove:function(){this.image&&this.image.remove(),this.figure&&this.figure.remove()},removeContent:function(){},renderEdges:function(){},renderContent:function(){},doLayout:function(){this.figure&&this.figure.layoutText()},toFront:function(){this.figure&&this.figure.toFront(),this.image&&this.image.toFront()},preferredSize:function(){return{width:this.get("width"),height:this.get("height")}},minimumSize:function(){return this.figure.minimumSize()},asEditable:function(){var t=this;t.diagram;var e=function(t){var e=t.bounds(),i=t.diagram.el.offsetLeft,r=t.diagram.el.offsetTop,s=e.x+(isNaN(i)?0:i),n=e.y+(isNaN(r)?0:r),h=e.width,o=e.height,a="form-input-"+t.get("id"),u=document.getElementById(a);u&&u.parentNode.removeChild(u),u=document.createElement("form");var c=document.createElement("input");return u.setAttribute("id",a),u.setAttribute("style","position: absolute; left: "+s+"px; top: "+n+"px;"),c.setAttribute("type","text"),c.value=t.getText()||"",c.setAttribute("style","width:"+h+"px; height: "+o+"px;"),u.appendChild(c),{form:u,input:c}},i=function(e){if(e.stopImmediatePropagation(),t.el){var r=t.el.input.value;t.setText(r),t.el.form.removeEventListener("blur",i,!0),t.el.form.parentNode.removeChild(t.el.form),delete t.el,delete t.domNode}};t.on("dblclick",function(r){r.stopImmediatePropagation();var s=e(t);t.el=s,t.domNode=t.diagram.el.parentNode,t.domNode.appendChild(s.form),t.el.form.focus(),t.el.form.addEventListener("blur",i,!0)})}});_.extend(s.Label.prototype,s.Selectable,s.Resizable,s.Events);var L=s.Shape=s.LayoutElement.extend({connectable:!0,showShadow:!1,resizable:!0,draggable:!0,showToolBox:!0,showBoundBox:!0,constructor:function(t){t||(t={}),s.DiagramElement.apply(this,[t]),this.attributes.ins=[],this.attributes.outs=[],_.isBoolean(t.draggable)&&(this.draggable=t.draggable),_.isBoolean(t.resizable)&&(this.resizable=t.resizable),_.isBoolean(t.showToolBox)&&(this.showToolBox=t.showToolBox),_.isBoolean(t.showBoundBox)&&(this.showBoundBox=t.showBoundBox),this.setUpChildren(t.children||this.children),this.setUpLayout(t),this.setUpStyles(t),this.setUpToolBox(),this.setUpBoundBox(),this.initialize.apply(this,arguments)},setUpToolBox:function(){this.showToolBox&&(this.toolBox=new B({element:this}))},setUpBoundBox:function(){this.showBoundBox&&(this.boundBox=new s.BoundBox({control:this}))},setUpStyles:function(t){_.each(_.keys(s.Styles),function(e){this[e]=t[e]?_.clone(t[e]):_.clone(s.Styles[e])},this)},render:function(){return this.layout&&this.set(this.layout.preferredSize()),this.figure.render(),this.renderContent(),this.on("touchstart click",this.select),this.on("touchstart click",this.showTool),this.on("touchstart mousedown",this.handleClick),this.on("touchend mouseout",this.removeToolWhenOut),this.draggable&&this.asDraggable(),this},dragConnection:function(t,e){if(t&&t.stopPropagation(),e&&"function"==typeof e){var i=this;i.connecting=!0;var r=new e;i.diagram.add(r),r.connectByDragging(i,t),r.render();var s=function(){i.connecting=!1,r.off("connect",s)};r.on("connect",s)}},showTool:function(){this._tool&&this._tool.render()},removeToolWhenOut:function(){var t=this;t.toolBox&&window.setTimeout(function(){t.toolBox&&!t.toolBox.isOver&&t.toolBox.remove()},1e3)},remove:function(t){this.deselect(),this.figure.remove(),_.each(this.get("children"),function(t){t.remove()}),_.each(this.get("ins"),function(e){e.remove(t)}),_.each(this.get("outs"),function(e){e.remove(t)}),this.shadow&&(this.shadowWrapper.remove(),delete this.shadowWrapper),this.selectionBox&&this.selectionBox.remove(),this.toolBox&&(this.toolBox.remove(),delete this.toolBox),t&&this.diagram.removeShape(this)},disconnect:function(t,e){return t?(!e||"in"!==e&&"out"!==e?(this.set("ins",_.without(this.ins,t)),this.set("outs",_.without(this.outs,t))):this.set([e+"s"],_.without(this[e+"s"],t)),this):this},canAdd:function(t){if("function"!=typeof t)return!1;if(!this.accepts)return!1;var e=new t({});return _.some(this.accepts,function(t){return e instanceof t})},canConnect:function(){return!0},toJSON:function(){return _.clone(this.attributes)},setUpLayout:function(t){this.layout=b.create(this,t)},removeContent:function(){_.each(this.attributes.children,function(t){t.remove()})},renderContent:function(){_.each(this.attributes.children,function(t){t.render()}),this.parent||this.doLayout()},renderEdges:function(){_.each(this.attributes.ins,function(t){t.render()}),_.each(this.attributes.outs,function(t){t.render()})},asDraggable:function(){return this.figure&&this.figure.asDraggable(),this}});s.Resizable={startResize:function(){this.toolBox&&this.toolBox.remove(),this.shadow&&this.shadowWrapper.remove(),_.each(this.selectionAnchors,function(t){t.active?t.hide():t.remove()}),this.removeContent(),this.figure&&this.figure.startResize(this.resizeStyle),this.trigger("start:resize")},resize:function(t,e,i){return this.resizable?(this.figure&&this.figure.resize(t,e,i),this.boundBox&&this.boundBox.render(),this.renderEdges(),this):this},endResize:function(){this.figure&&this.figure.endResize(),this.renderContent(),this.shadow&&this.createShadow(),this.boundBox&&this.boundBox.remove(),this.trigger("end:resize")}},_.extend(s.Shape.prototype,s.Selectable,s.Resizable,s.Events),s.arrows={none:function(t){return t||(t=2),{path:"M"+t+",0L"+-t+",0",dx:t,dy:t,attr:{opacity:0}}},basic:function(t,e){return e||(e=4),{path:["M",""+e,"0","L",""+-e,""+-e,"L",""+-e,""+e,"z"],dx:e,dy:e,attr:{stroke:"black",fill:"black"}}}};var R=s.ConnectionAnchor=s.DiagramElement.extend({constructor:function(t){s.DiagramElement.apply(this,[t]),this.connection=t.connection},bounds:function(){return this.wrapper?this.wrapper.getABox():null},position:function(){return this.connection.get("sourceAnchor")===this?"source":"end"},move:function(t){return this.x=t.x,this.y=t.y,this.wrapper&&this.wrapper.attr({x:this.x-2,y:this.y-2}),this},render:function(){if(this.wrapper)return this;var t=this.connection.renderer();return this.wrapper=t.rect(this.x-3,this.y-3,6,6),this.wrapper.attr({fill:"black",stroke:"none"}),this.wrapper.anchor=this,this.asDraggable(),this},remove:function(){this.wrapper&&this.wrapper.remove()},getConnectableElement:function(){var t=this;this.wrapper;var e=this.connection,i=e.diagram,r=i.getShapesByPoint(this.x,this.y),s=function(i,r){return e.canConnect(r,t.position())&&i.push(r),i},n=_.reduceRight(r,s,[]);return n.length?n[0]:null},establishConnection:function(t){var e=this;this.wrapper,t&&(e.shape=t),e.connection.state=null,"end"===this.position()?e.connection.connect(e.connection.get("sourceAnchor").shape,e.shape):e.connection.connect(e.shape,e.connection.get("targetAnchor").shape),e.connection.render()},asDraggable:function(){var t=function(t,e){this.attr({x:this.ox+t,y:this.oy+e}),this.anchor.connection.state="dragging",this.anchor.connection.dragger=this.anchor,this.anchor.connection.render()},e=function(){this.o(),this.anchor.shape.disconnect(this.anchor.connection)},i=function(){var t=this.anchor.getConnectableElement();t&&this.anchor.establishConnection(t)};return this.wrapper.drag(t,e,i),this},attach:function(t){var e=t.bounds();return e.xCenter&&e.yMiddle&&(this.x=e.xCenter,this.y=e.yMiddle),this.shape=t,this},hide:function(){return this.wrapper&&this.wrapper.hide(),this},show:function(){return this.wrapper&&this.wrapper.show(),this},toFront:function(){return this.wrapper&&this.wrapper.toFront(),this},toBack:function(){return this.wrapper&&this.wrapper.toBack(),this},toJSON:function(){return this.set("x",this.wrapper.x()),this.set("y",this.wrapper.y()),this._deepClone(this.attributes)}}),P=function(t,e,i,r,s){if(this.paper=t,this.point=e,this.angle=i,this.radians=r,this.attributes={},this.attributes.attr={},s){this.attributes.type=s.type;var n=Raphael._availableAttrs;for(var h in s)_.has(n,h)&&(this.get("attr")[h]=s[h])}return this};_.extend(P.prototype,s.Element.prototype),P.prototype.remove=function(){this.wrapper&&this.wrapper.remove()},P.prototype.render=function(){var t=this.get("type");if(!t||"none"===t)return this;var e;e="function"==typeof s.arrows[t]?s.arrows[t](this.point):s.arrows.basic(this.point);var i=this.point.x+-1.5*(e.dx-1)*Math.cos(this.radians),r=this.point.y+1.5*(e.dy-1)*Math.sin(this.radians);return this.wrapper=this.paper.path(e.path.join(" ")),this.wrapper.attr(e.attr),this.wrapper.attr(this.get("attr")),this.wrapper.translate(i,r),this.wrapper.rotate(this.angle),this},s.ConnectionLabel=s.DiagramElement.extend({constructor:function(t){if(s.DiagramElement.apply(this,[t]),!t.connection)throw Error("ConnectionLabel must have a parent Connection");this.connection=t.connection,this.diagram=this.connection.diagram,this.position=t.position,this.set("text",t.text)},remove:function(){this.wrapper&&this.wrapper.remove()},render:function(){this.remove();var t,e=this.renderer(),i=this.connection,r=this.wrapper=e.text(0,0,this.get("text")),s=function(t,e,i,r){var s=i>e.xCenter,n=e.yMiddle>r,h=t.getBBox(),o=s?10+h.width/2:10-h.width,a=n?-10:10;return{x:i+o,y:r+a}},n=function(){var t=i.get("targetAnchor"),e=t.shape.bounds();return abox=t.bounds(),x=abox.xCenter,y=abox.yMiddle,Math.sqrt(x*x+y*y),Math.atan(y/x),s(r,e,x,y)},h=function(){var t=i.get("sourceAnchor"),e=t.shape.bounds(),n=t.bounds(),h=n.xCenter,o=n.yMiddle;return s(r,e,h,o)},o=function(){var t=i.get("sourceAnchor"),e=i.get("targetAnchor"),r=t.bounds(),s=e.bounds(),n=r.xCenter,h=r.yMiddle,o=s.xCenter,a=s.yMiddle,u=(n+o)/2,c=(h+a)/2;return c-=10,{x:u,y:c}};switch(this.position){case"start":t=h();break;case"end":t=n();break;default:t=o()}return this.wrapper.transform(["t",t.x,",",t.y].join("")),this.asEditable().asDraggable(),this},setText:function(t){this.set("text",t),this.trigger("change:text",t),this.wrapper&&this.wrapper.attr("text",t)},asDraggable:function(){var t=function(){this.o()},e=function(){},i=function(t,e){var i=this.ox+t,r=this.oy+e;this.attr({x:i,y:r})};return this.wrapper&&(this.wrapper.attr({cursor:"move"}),this.wrapper.drag(i,t,e)),this},asEditable:function(){var t=this,e=this.connection.diagram;if(t.wrapper){var i=function(t){var e=t.bounds(),i=t.connection.diagram,r=i.canvas().offsetLeft,s=i.canvas().offsetTop,n=e.x+(isNaN(r)?0:r),h=e.y+(isNaN(s)?0:s),o=e.width+20,a=20,u=document.createElement("form");u.setAttribute("style","position: absolute; left: "+n+"px; top: "+h+"px;");var c=document.createElement("input");return c.setAttribute("type","text"),c.setAttribute("placeholder",t.wrapper.attr("text")),c.setAttribute("style","padding: 0; width:"+o+"px; height: "+a+"px; z-index: 1;"),u.appendChild(c),{form:u,input:c}},r=function(t){t&&t.parentNode&&t.parentNode.removeChild(t)};return t.wrapper.dblclick(function(){var s=e.modifiedLabel;s&&s!==t&&(r(e.inputText),r(e.modifiedLabel.textForm)),t.textForm&&r(t.textForm);var n=i(t);t.textForm=n.form,e.inputText=n.input,e.modifiedLabel=t,e.canvas().parentNode.appendChild(n.form)}),this}}}),i.prototype.render=function(){return this.remove(),this.wrapper=this.paper.rect(this.x-3,this.y-3,6,6,0),this.wrapper.attr({fill:"black",stroke:"none",cursor:"pointer"}),this.drag(),this.wrapper.toFront(),this},i.prototype.remove=function(){this.wrapper&&this.wrapper.remove()},i.prototype.drag=function(){if(!this.wrapper)return this;var t=this,e=this.connection,i=function(i,r){this.attr({x:this.ox+i,y:this.oy+r});var s=this.getABox();t.x=s.center.x,t.y=s.center.y,e.render()},r=function(){this.o(),t.state="dragging",this.attr("cursor","move")},s=function(){delete t.state,e.deselect()};this.wrapper.drag(i,r,s)},s.Connection=s.DiagramElement.extend({toolbox:!0,constructor:function(t){t||(t={}),s.DiagramElement.apply(this,[t]),this.set("sourceAnchor",new R({connection:this})),this.set("targetAnchor",new R({connection:this})),this.vertices=[],this.toolbox&&(this._tool=new B({element:this})),t.source&&t.target&&this.connect(t.source,t.target),this.initialize.apply(this,arguments)},initialize:function(){},addPoint:function(t){var e=new i(this,t);return this.vertices.push(e),this.vertices=_.sortBy(this.vertices,function(t){return t.x}),this.render(),this},remove:function(t){return this.wrapper&&(this.unBindEvents(),this.wrapper.remove(),this.dummy.remove()),this.startArrow&&this.startArrow.remove(),this.endArrow&&this.endArrow.remove(),this._tool&&this._tool.remove(),this.labels&&_.each(this.labels,function(t){t.remove()}),_.each(this.vertices,function(t){t.state||t.remove()}),t&&(this.disconnect(),this.get("sourceAnchor").remove(),this.get("targetAnchor").remove(),this.diagram.removeConnection(this)),this.off("click",this._handleClick),this.off("dblclick",this._createFlexPoint),this},renderConnectionEnd:function(t,e){var i,r=this.renderer(),s=t[0],n=t[1],o=e[0],a=e[1];i=this.vertices.length?h.theta(this.vertices[this.vertices.length-1],n.center):h.theta(s.center,n.center);var u=360-i.degrees+180,c=360-i.degrees;this.startArrow=new P(r,o,u,i.radians,this.start),this.endArrow=new P(r,a,c,i.radians,this.end),this.startArrow.render(),this.endArrow.render()},renderAnchors:function(t){var e=t[0],i=t[1];this.get("sourceAnchor").move(e).render().hide(),this.get("targetAnchor").move(i).render().hide()},createPath:function(){var t=r(this.get("sourceAnchor"),this.get("targetAnchor"),this.vertices,!1),e=this.renderer();return this.wrapper=e.path(t.join(" ")),this.wrapper.attr(this.attributes),this.wrapper.controller=this,t},createEventPath:function(t){var e=this.renderer();this.dummy=e.path(t.join(" ")),this.dummy.connection=this,this.dummy.attr({cursor:"pointer",fill:"none",opacity:0,"stroke-width":8})},_events:["click","dblclick","mouseover","mouseout"],bindEvents:function(){var t=this,e=this.dummy,i=function(e){return{eve:e,handler:function(i){t.trigger(e,i)}}},r=function(t){e[t.eve](t.handler)};this.eveHandlers=_.map(this._events,i),_.each(this.eveHandlers,r)},unBindEvents:function(){var t=this.dummy,e=function(e){t["un"+e.eve](e.handler)};_.each(this.eveHandlers,e),this.eveHandlers.length=0},render:function(){var t=this.getBoxes(),e=this.getPoints(t);return 2!==e.length?this:(this.remove(),this.renderAnchors(e),this.createEventPath(this.createPath()),this.renderConnectionEnd(t,e),this.bindEvents(),this.on("click",this.showToolBox),this.on("click",this.select),this.on("dblclick",this.createFlexPoint),this.labels&&_.each(this.labels,function(t){t.render()}),this)},showToolBox:function(){var t=this._tool;this.diagram,t&&t.render()},createFlexPoint:function(t){var e=h.get(this.diagram,t);this.addPoint(e),this.select()},select:function(){this.diagram.setSelection(this),this.get("sourceAnchor").toFront().show(),this.get("targetAnchor").toFront().show(),_.each(this.vertices,function(t){t.render()}),this.trigger("select")},deselect:function(){this.get("sourceAnchor").toFront().hide(),this.get("targetAnchor").toFront().hide(),_.each(this.vertices,function(t){t.remove()}),this.trigger("deselect")},connect:function(t,e){return t&&e?(this.set("source",t),this.set("target",e),this.get("sourceAnchor").attach(t),this.get("targetAnchor").attach(e),t.trigger("connect:source",this),e.trigger("connect:target",this),this.trigger("connect"),t.get("outs").push(this),e.get("ins").push(this),this):this},disconnect:function(){var t=this.get("source"),e=this.get("target");return t&&t.disconnect(this,"out"),e&&e.disconnect(this,"in"),this.set("source",null),this.set("target",null),this.trigger("disconnect"),this},connectByDragging:function(t,e){var i=this.diagram,r=i.renderer(),s=this,n=this.dragger=this.get("targetAnchor"),o=h.get(r,e);this.set("source",t),this.get("sourceAnchor").attach(t),t.get("outs").push(this),this.state="dragging",this.dragger.move(o),this.dragger.render();var a=function(t){var e=h.get(r,t);n.move(e),s.render()},u=function(){var t=n.getConnectableElement();t&&(n.establishConnection(t),i.off("mouseup",u),i.off("mousemove",a),i.toBack())};i.toFront(),i.on("mousemove",a),i.on("mouseup",u)},canConnect:function(){return!0},toJSON:function(){var t={};return t.source=this.get("source").get("id"),t.target=this.get("target").get("id"),t.type=this.get("type"),t.id=this.id,t.sourceAnchor=this.get("sourceAnchor"),t.targetAnchor=this.get("targetAnchor"),t},getBoxes:function(){var t,e;return this.renderer(),"dragging"===this.state?this.dragger===this.get("sourceAnchor")?(t=this.get("sourceAnchor").bounds(),e=this.get("target").bounds()):(t=this.get("source").bounds(),e=this.get("targetAnchor").bounds()):(t=this.get("source").bounds(),e=this.get("target").bounds()),[t,e]},getPoints:function(t){var e,i,r,s=this.renderer(),n=t[0],a=t[1];return this.vertices.length?(e=new o(s,n.center,this.vertices[0]),i=e.findIntersection(n),e.remove(),e=new o(s,this.vertices[this.vertices.length-1],a.center),r=e.findIntersection(a),e.remove()):(e=new o(s,n.center,a.center),i=e.findIntersection(n),r=e.findIntersection(a),e.remove()),i||(i={x:n.xCenter,y:n.yMiddle}),r||(r={x:a.xCenter,y:a.yMiddle}),[new h(i),new h(r)]}}),_.extend(s.Connection.prototype,s.Events)})(this);