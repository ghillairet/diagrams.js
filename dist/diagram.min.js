(function(){function N(e,t,n,r){var i=["M",e.x,e.y],s=0,o=n.length;for(;s<o;s++)i.push("L",n[s].x,n[s].y);return i.push("L",t.x,t.y),i}function C(e,t){var n=-(t.y-e.y),r=t.x-e.x,i=Math.atan2(n,r);return i<0&&(i=2*Math.PI+i),{degrees:180*i/Math.PI,radians:i}}var e=this;e.Diagram=Diagram={version:"0.0.1"};var t=function(t,n){var r;n===undefined?(r=t.split(t.indexOf("@")===-1?" ":"@"),this.x=parseInt(r[0],10),this.y=parseInt(r[1],10)):(this.x=t,this.y=n)};t.getMousePosition=function(e,n){if(window.event&&window.event.contentOverflow!==undefined)return new t(window.event.x,window.event.y);if(n.offsetX!==undefined&&n.offsetY!==undefined)return new t(n.offsetX,n.offsetY);var r=n.pageX,i=n.pageY,s=e.canvas.parentNode,o=s?s.offsetLeft:0,u=s?s.offsetTop:0,a=s?s.offsetParent:0,f=r-o,l=i-u;while(a)f+=a.offsetLeft,l+=a.offsetTop,a=a.offsetParent;return new t(f,l)};var n=function(e,t,n){return this.paper=e,this.start=t,this.end=n,this.wrapper=e.path("M"+this.start.x+","+this.start.y+"L"+this.end.x+","+this.end.y),this};n.prototype.attr=function(){return Raphael.el.attr.apply(this.wrapper,arguments)},n.prototype.remove=function(){this.wrapper.remove()},n.prototype.intersection=function(e){var t={x:this.end.x-this.start.x,y:this.end.y-this.start.y},n={x:e.end.x-e.start.x,y:e.end.y-e.start.y},r=t.x*n.y-t.y*n.x,i={x:e.start.x-this.start.x,y:e.start.y-this.start.y},s=i.x*n.y-i.y*n.x,o=i.x*t.y-i.y*t.x;if(r===0||s*r<0||o*r<0)return null;if(r>0){if(s>r||o>r)return null}else if(s<r||o<r)return null;return{x:this.start.x+s*t.x/r,y:this.start.y+s*t.y/r}},n.prototype.findIntersection=function(e){var t=[{p1:e.topLeft,p2:e.topRight},{p1:e.topLeft,p2:e.bottomLeft},{p1:e.bottomLeft,p2:e.bottomRight},{p1:e.bottomRight,p2:e.topRight}];for(var r=0;r<t.length;r++){var i=new n(this.paper,t[r].p1,t[r].p2),s=this.intersection(i);i.remove();if(s)return s}return null};var r=function(e){return _.isNumber(e)&&_.isFinite(e)?e>0:!1};Raphael.el.is=function(e){return this.type===e},Raphael.el.x=function(){switch(this.type){case"ellipse":case"circle":return this.attr("cx");default:return this.attr("x")}},Raphael.el.y=function(){switch(this.type){case"ellipse":case"circle":return this.attr("cy");default:return this.attr("y")}},Raphael.el.rdxy=function(e,t,n){switch(this.type){case"ellipse":if(n==="ne"||n==="nw")t=-t;if(n==="nw"||n==="sw")e=-e;var i=this.orx+e,s=this.orx+t;return{rx:r(i)?i:this.orx,ry:r(s)?s:this.ory};case"circle":if(n==="ne"||n==="nw")t=-t;var o=this.or+(t<0?-1:1)*Math.sqrt(2*t*t);return{r:r(o)?o:this.or};case"rect":var u=this.ow+e;if(n==="nw"||n==="sw")u=this.ow-e;var a=this.oh+t;if(n==="ne"||n==="nw")a=this.oh-t;var f=this.oy,l=this.ox;if(n==="sw"||n==="nw")l=this.ox+e;if(n==="ne"||n==="nw")f=this.oy+t;return{width:r(u)?u:this.ow,height:r(a)?a:this.oh,y:f,x:l};default:return{}}},Raphael.el.o=function(){var e=this.attr();return this.ox=this.x(),this.oy=this.y(),this.ow=e.width,this.oh=e.height,this.or=e.r,this.orx=e.rx,this.ory=e.ry,this},Raphael.el.getABox=function(){var e=this.getBBox(),t={x:e.x,y:e.y,width:e.width,height:e.height,xLeft:e.x,xCenter:e.x+e.width/2,xRight:e.x+e.width,yTop:e.y,yMiddle:e.y+e.height/2,yBottom:e.y+e.height};return t.center={x:t.xCenter,y:t.yMiddle},t.topLeft={x:t.xLeft,y:t.yTop},t.topRight={x:t.xRight,y:t.yTop},t.bottomLeft={x:t.xLeft,y:t.yBottom},t.bottomRight={x:t.xRight,y:t.yBottom},t.top={x:t.xCenter,y:t.yTop},t.bottom={x:t.xCenter,y:t.yBottom},t.left={x:t.xLeft,y:t.yMiddle},t.right={x:t.xRight,y:t.yMiddle},t},Raphael.fn.polyline=function(e,t){var n=["M",e,t,"L"];for(var r=2;r<arguments.length;r++)n.push(arguments[r]);return this.path(n.join(" "))};var i=/\s+/,s=Diagram.Events={on:function(e,t,n){var r,s,o;if(!t)return this;e=e.split(i),r=this._callbacks||(this._callbacks={});while(s=e.shift())o=r[s]||(r[s]=[]),o.push(t,n);return this},off:function(e,t,n){var r,s,o,u;if(!(s=this._callbacks))return this;if(!(e||t||n))return delete this._callbacks,this;e=e?e.split(i):_.keys(s);while(r=e.shift()){if(!(o=s[r])||!t&&!n){delete s[r];continue}for(u=o.length-2;u>=0;u-=2)t&&o[u]!==t||n&&o[u+1]!==n||o.splice(u,2)}return this},trigger:function(e){var t,n,r,s,o,u,a,f;if(!(n=this._callbacks))return this;f=[],e=e.split(i);for(s=1,o=arguments.length;s<o;s++)f[s-1]=arguments[s];while(t=e.shift()){if(a=n.all)a=a.slice();if(r=n[t])r=r.slice();if(r)for(s=0,o=r.length;s<o;s+=2)r[s].apply(r[s+1]||this,f);if(a){u=[t].concat(f);for(s=0,o=a.length;s<o;s+=2)a[s].apply(a[s+1]||this,u)}}return this}},o=this.Backbone;o&&(s=o.Events),Diagram.arrows={none:function(e){return e||(e=2),{path:"M"+e+",0L"+ -e+",0",dx:e,dy:e,attr:{opacity:0}}},basic:function(e,t){return t||(t=4),{path:["M",t.toString(),"0","L",(-t).toString(),(-t).toString(),"L",(-t).toString(),t.toString(),"z"],dx:t,dy:t,attr:{stroke:"black",fill:"black"}}}};var u=Diagram.Element=function(e){this.initialize.apply(this,arguments)},a=function(e,t){return l(this,e,t)},f=function(){},l=function(e,t,n){var r;return t&&t.hasOwnProperty("constructor")?r=t.constructor:r=function(){e.apply(this,arguments)},_.extend(r,e),f.prototype=e.prototype,r.prototype=new f,t&&_.extend(r.prototype,t),n&&_.extend(r,n),r.prototype.constructor=r,r.__super__=e.prototype,r};u.prototype.initialize=function(e){},u.prototype.has=function(e){return this.attributes[e]!=null},u.prototype.get=function(e){return this.attributes[e]},u.prototype.set=function(e,t){this.attributes[e]=t},u.prototype.toJSON=function(){var e=this.attributes,t=_.clone(e);return this._deepClone(t)},u.prototype._deepClone=function(e){for(var t in e){var n=e[t];if(_.isArray(n)){var r=[];for(var i=0;i<n.length;i++){var s=n[i];s.attributes&&(r[i]=s.toJSON())}e[t]=r}else _.isObject(n)&&n.attributes&&(e[t]=n.toJSON())}return e},u.extend=a,Diagram.SVGElement=function(){},_.extend(Diagram.SVGElement.prototype,Diagram.Element.prototype),Diagram.SVGElement.prototype.paper=function(){if(!this.diagram)throw new Error("SVGElement must be associated to a diagram");return this.diagram._paper},Diagram.SVGElement.prototype._get=function(e){var t;return this.attributes.attr?t=this.attributes.attr[e]?this.attributes.attr[e]:this.figure[e]:t=this.figure[e],isNaN(t)?0:t},Diagram.SVGElement.prototype._attr=function(e){var t=Raphael._availableAttrs,n=e.attr||{};for(var r in e)_.has(t,r)&&(n[r]=e[r]);return n},Diagram.SVGElement.prototype._rect=function(){var e=this._get("x"),t=this._get("y"),n=this._get("width"),r=this._get("height"),i=this._get("r"),s=this.get("attr");return this.paper().rect(e,t,n,r,i).attr(s)},Diagram.SVGElement.prototype._circle=function(){var e=this._get("x"),t=this._get("y"),n=this._get("r"),r=this.get("attr");return e===0&&(e=this._get("cx")),t===0&&(t=this._get("cy")),delete r.x,delete r.y,this.paper().circle(e,t,n).attr(r)},Diagram.SVGElement.prototype._ellipse=function(){var e=this._get("x"),t=this._get("y"),n=this._get("rx"),r=this._get("ry"),i=this.get("attr");return this.paper().ellipse(e,t,n,r).attr(i)},Diagram.SVGElement.prototype._path=function(){var e=this._get("path"),t=this.get("attr");return this.paper().path(e).attr(t)},Diagram.SVGElement.prototype._createFigure=function(){var e=null;switch(this.get("attr").type){case"rect":e=this._rect();break;case"circle":e=this._circle();break;case"ellipse":e=this._ellipse();break;case"path":e=this._path();break;default:e=null}if(!e)throw new Error("Cannot create figure");return e},Diagram.SVGElement.prototype.remove=function(){return this.wrapper&&this.wrapper.remove(),this},Diagram.SVGElement.prototype.show=function(){return this.wrapper.show()},Diagram.SVGElement.prototype.hide=function(){return this.wrapper.hide()},Diagram.SVGElement.prototype.toFront=function(){return this.wrapper.toFront()},Diagram.SVGElement.prototype.attr=function(){return Raphael.el.attr.apply(this.wrapper,arguments)},Diagram.Diagram=function(e,t,n,r){return this._el=e,this.width=t,this.height=n,this.paper(Raphael(this._el,this.width,this.height)),this.attributes={name:"",type:"",children:[],edges:[]},_.isObject(r)&&_.each(_.keys(r),function(e){this.attributes[e]=r[e]},this),this.type&&this.set("type",type),this.currentSource=undefined,this.currentEdge=undefined,this},Diagram.Diagram.extend=a,_.extend(Diagram.Diagram.prototype,Diagram.Element.prototype,s),Diagram.Diagram.prototype.paper=function(e){return e&&(this._paper=e,this.canvas().addEventListener("click",this)),this._paper},Diagram.Diagram.prototype.zoom=function(e,t){},Diagram.Diagram.prototype.el=function(){return this._el?document.getElementById(this._el):null},Diagram.Diagram.prototype.canvas=function(){return this._paper?this._paper.canvas:null},Diagram.Diagram.prototype.createShape=function(e,t){var n=null;if(!e)throw new Error("Cannot create Shape if Shape constructor is missing");return t.diagram=this,n=new e(t),n.on("remove",this.removeShape,this),this.trigger("add:children",n),n},Diagram.Diagram.prototype.removeShape=function(e){if(e){var t=this.get("children");this.set("children",_.reject(t,function(t){return t===e})),this.trigger("remove:children",e)}},Diagram.Diagram.prototype.createConnection=function(e,t){var n=null;if(typeof e=="function"){var r=t.source,i=t.target;r&&i&&(n=new e({diagram:this}),n.connect(r,i),this.get("edges").push(n),n.on("remove:source remove:target",function(e){this.removeConnection(e)},this),this.trigger("add:edges",n))}return n},Diagram.Diagram.prototype.removeConnection=function(e){if(e){e.disconnect(),e.remove();var t=this.get("edges");this.set("edges",_.reject(t,function(t){return t===e})),this.trigger("remove:edges",e)}},Diagram.Diagram.prototype.canConnect=function(e){return this.currentEdge?this.currentSource?!0:(this.currentSource=e,!1):!1},Diagram.Diagram.prototype.connect=function(e){var t=null;return this.currentEdge&&this.currentSource&&(t=this.createConnection(this.currentEdge,{source:this.currentSource,target:e}),this.currentEdge=null,this.currentSource=null),t},Diagram.Diagram.prototype.handleTextInput=function(){var e=$(this.inputText).val();e&&(this.modifiedLabel.setText(e),$(this.modifiedLabel.textForm).remove(),this.modifiedLabel.textForm=null,this.modifiedLabel=null,this.inputText=null),this.repeatInputClick?this.modifiedLabel&&($(this.modifiedLabel.textForm).remove(),this.modifiedLabel.textForm=null,this.modifiedLabel=null,this.inputText=null,this.repeatInputClick=!1):this.repeatInputClick=!0},Diagram.Diagram.prototype.handleEvent=function(e){var n=t.getMousePosition(this._paper,e),r=this._paper.getElementsByPoint(n.x,n.y);r.length===0&&this.selected&&this.selected.deselect(),this.inputText&&this.handleTextInput(),r.length===0&&this.currentEdge&&(this.currentEdge=null);var i=this.currentTool;if(i){if(this._canCreate(i)){var s=this.createShape(i,n);this.attributes.children.push(s),s.render()}r.length===0&&(this.currentTool=null)}},Diagram.Diagram.prototype._canCreate=function(e){var t=_.find(this.child,function(t){return t===e});return t!==undefined},Diagram.Diagram.prototype.load=function(e){e.name&&this.set("name",e.name),e.type&&this.set("type",e.type);var t=this.get("children");_.each(e.children,function(e){var n=this.loadShape(e);n&&(t.push(n),n.render())},this);var n=this.get("edges");_.each(e.edges,function(e){var t=this.loadEdge(e);t&&(n.push(t),t.render())},this)},Diagram.Diagram.prototype._getConstructor=function(e){var t=e.split("."),n=window;for(var r=0;r<t.length;r++)n=n[t[r]];return n},Diagram.Diagram.prototype.loadShape=function(e){if(!e.type)throw new Error("Cannot create Shape, type is undefined");var t=this._getConstructor(e.type);return typeof t=="function"?this.createShape(t,e):null},Diagram.Diagram.prototype.loadEdge=function(e,t){if(!e.type)throw new Error("Cannot create Edge, type is undefined");var n=this._getConstructor(e.type);if(typeof n=="function"){var r=t?t:this.get("children"),i=_.find(t,function(t){return t.get("id")==e.source}),s=_.find(t,function(t){return t.get("id")==e.target});if(i&&s){var o=new n({diagram:this});if(o)return o.connect(i,s),o}}return null};var c=Diagram.ToolBox=function(e){return this.element=e.element,this.diagram=this.element.diagram,this.width=40,this.height=20,this.children=[],this};_.extend(c.prototype,Diagram.SVGElement.prototype),c.prototype.render=function(){if(!this.element&&!this.element.wrapper)return;this.wrapper&&this.wrapper.remove();var e=this.paper(),t=this.element.wrapper.getABox(),n=t.xRight-this.width+8,r=t.y-this.height-8;this.wrapper=e.rect(n,r,this.width,this.height,4).attr({fill:"whitesmoke",stroke:"whitesmoke","stroke-width":1}),this.wrapper.controller=this,this.wrapper.mouseover(this.handleMouseOver),this.wrapper.mouseout(this.handleMouseOut),t=this.wrapper.getABox();var i=this;this.addItem(t.x+12,t.yMiddle,"X",function(e){i.element.remove()});var s=this.propertyBox=new c.propertyBox({diagram:i.diagram});return c.propertyBox&&this.addItem(t.xRight-12,t.yMiddle,"P",function(e){var t=i.element.wrapper.getABox();s.x=t.xRight+20,s.y=t.y,s.render()}),this},c.prototype.addItem=function(e,t,n,r){var i=this,s=this.paper(),o=s.text(e,t,n);return this.children.push(o),o.mouseover(function(e){i.isOverChild=!0}),o.mouseout(function(e){i.isOverChild=!1}),o.click(r),this},c.prototype.remove=function(){this.wrapper&&(this.wrapper.remove(),_.each(this.children,function(e){e.remove()}),this.children.length=0)},c.prototype.handleMouseOver=function(){this.controller.isOver=!0,this.controller.isOverChild=!1},c.prototype.handleMouseOut=function(){var e=this.controller;window.setTimeout(function(){e&&!e.isOverChild&&(e.isOver=!1,e.remove())},200)},Diagram.Draggable=function(){},Diagram.Draggable.prototype.asDraggable=function(e){this.wrapper&&this.wrapper.attr({cursor:"move"});var t=function(){this.o();if(this.controller){var e=this.controller;typeof e.deselect=="function"&&e.deselect(),e.shadow&&e.shadowWrapper.remove(),e._tool&&e._tool.remove(),this.unmouseover(e.handleMouseOver),this.unmouseout(e.handleMouseOut);var n=e.get("children");if(n&&n.length)for(var r=0;r<n.length;r++)t.apply(n[r].wrapper)}},n=function(e,t,r,i,s){var o=this.getBBox(),u=this.ox+e,a=this.oy+t,f=this.is("circle")||this.is("ellipse")?o.width/2:0,l=this.paper;u=Math.min(Math.max(f,u),l.width-(this.is("circle")||this.is("ellipse")?f:o.width)),a=Math.min(Math.max(f,a),l.height-(this.is("circle")||this.is("ellipse")?f:o.height));var c={x:u,y:a,cx:u,cy:a};this.attr(c);if(this.controller){var h=this.controller;if(h.isConnectable){var p=h.inEdges,d=h.outEdges;if(p&&p.length)for(var v=0;v<p.length;v++)p[v].render();if(d&&d.length)for(var v=0;v<d.length;v++)d[v].render()}var m=h.get("children");if(m&&m.length)for(var v=0;v<m.length;v++)n.apply(m[v].wrapper,[e,t,r,i,s])}},r=function(){var e=this.controller;this.mouseover(e.handleMouseOver),this.mouseout(e.handleMouseOut),e&&e.shadow&&e.createShadow()};return this.wrapper.drag(n,t,r),this},Diagram.Selectable={select:function(){this.diagram.selected&&this.diagram.selected.deselect(),this.diagram.selected=this;if(this.wrapper){bbox=this.wrapper.getABox(),this.selectionAnchors=[];var e=(new v({box:this})).render(),t=(new p({box:this})).render(),n=(new d({box:this})).render(),r=(new m({box:this})).render();this.resizable&&(e.resizable(),t.resizable(),r.resizable(),n.resizable()),this.selectionAnchors.push(t),this.selectionAnchors.push(e),this.selectionAnchors.push(n),this.selectionAnchors.push(r)}},deselect:function(){this.selectionAnchors&&_.each(this.selectionAnchors,function(e){e.remove()})}};var h=function(e){this.box=e.box,this.diagram=this.box.diagram,this.initialize.apply(this,arguments)};h.cursor="",_.extend(h.prototype,Diagram.SVGElement.prototype),h.extend=a,h.prototype.initialize=function(e){},h.prototype.render=function(){var e=this.paper();return this.wrapper=e.rect(this.x,this.y,8,8,0).attr({fill:"grey",stroke:"whitesmoke","stroke-width":1,"stroke-opacity":1,opacity:1}),this.box.resizable&&this.wrapper.attr({cursor:this.cursor}),this.wrapper.box=this.box.wrapper,this.wrapper.anchor=this,this},h.prototype.remove=function(){this.wrapper&&this.wrapper.remove();if(this.box){var e=this.box;this.box=null,e.anchor&&(e.anchor=null)}},h.start=function(){this.o(),this.box.o();var e=this.anchor,t=this.box.controller;t.shadow&&t.shadowWrapper.remove(),_.each(t.selectionAnchors,function(t){t!==e&&t.remove()});if(t.has("children")){var n=t.get("children");if(n&&n.length)for(var r=0;r<n.length;r++)h.startInner.apply(n[r])}},h.startInner=function(){this.wrapper.o();if(this.has("children")){var e=this.get("children");if(e&&e.length)for(var t=0;t<e.length;t++)h.startInner.apply(e[t])}},h.move=function(e,t,n,r,i){this.attr({x:this.ox+e,y:this.oy+t});if(this.box.controller){var s=this.box.controller;s.resize(e,t,this.anchor.direction),s.isConnectable&&(_.each(s.inEdges,function(e){e.render()}),_.each(s.outEdges,function(e){e.render()}))}},h.end=function(){var e=this.box.controller;e&&e.shadow&&e.createShadow(),this.anchor&&this.anchor.box.select()};var p=h.extend({initialize:function(e){var t=e.box.wrapper.getABox();this.x=t.x-4,this.y=t.y-4,this.cursor="nw-resize",this.direction="nw"},resizable:function(){return this.wrapper.drag(h.move,h.start,h.end),this}}),d=h.extend({initialize:function(e){var t=e.box.wrapper.getABox();this.x=t.xLeft-4,this.y=t.yBottom-4,this.cursor="sw-resize",this.direction="sw"},resizable:function(){return this.wrapper.drag(h.move,h.start,h.end),this}}),v=h.extend({initialize:function(e){var t=e.box.wrapper.getABox();this.x=t.xRight-4,this.y=t.y-4,this.cursor="ne-resize",this.direction="ne"},resizable:function(){return this.wrapper.drag(h.move,h.start,h.end),this}}),m=h.extend({initialize:function(e){var t=e.box.wrapper.getABox();this.x=t.xRight-4,this.y=t.yBottom-4,this.cursor="se-resize",this.direction="se"},resizable:function(){return this.wrapper.drag(h.move,h.start,h.end),this}}),g=Diagram.Image=function(e){return this.parent=e.parent,this.diagram=this.parent.diagram,this.attributes={},this.set("type","Diagram.Image"),this.set("width",e.width),this.set("height",e.height),this.set("src",e.src),this};_.extend(g.prototype,Diagram.SVGElement.prototype),g.prototype.render=function(){var e=this.paper(),t=this.parent.wrapper.getBBox(),n=this.get("src"),r=this.get("width"),i=this.get("height");return this.wrapper=e.image(n,t.x,t.y,r,i),this.wrapper.toFront(),this.wrapper.controller=this,this},g.prototype.center=function(){var e=this.parent.wrapper.getABox();this.wrapper.attr({x:e.x-this.get("width")}),this.wrapper.attr({y:e.yMiddle-this.get("height")/2})};var y=Diagram.Label=function(e){e||(e={}),this.attributes={},this.attributes.children=[],this.attributes.type="Diagram.Label",this._positions=["top-left","top-right","top-center","bottom-left","bottom-right","bottom-center","center-left","center-right","center"],this.parent=e.parent||undefined,this.diagram=this.parent?this.parent.diagram:e.diagram,this.position=this._getPosition(e),this.resizable=e.resizable||!1,this.draggable=e.draggable||!1,this.editable=e.editable||!0,e.id!=null?this.set("id",e.id):this.set("id",_.uniqueId()),this.xOffset=5,this.yOffset=5,this.set("attr",this._attr(e)),this.set("position",this.position),this.initChildren(e),e.width&&(this.width=e.width),e.height&&(this.height=e.height),e.text?this.set("text",e.text):this.set("text","Label")};_.extend(y.prototype,Diagram.SVGElement.prototype,Diagram.Draggable,s),y.prototype._getPosition=function(e){if(e.position){var t=e.position;if(t.x&&t.y)return t;if(_.include(this._positions,t))return t}return"center"},y.prototype.initChildren=function(e){var t=e.children;if(t&&t.length>0)_.each(t,function(e){if(e.type==="Diagram.Image"){var t=this.createImage(e);this.get("children").push(t)}},this);else if(e.image){var n=this.createImage(e.image);this.get("children").push(n)}},y.prototype.createImage=function(e){e.parent=this;var t=new Diagram.Image(e);return this.image=t,t},y.prototype.render=function(){var e=this.paper(),t,n,r=this.parent.wrapper.getABox();return this.position.x&&this.position.y?(t=r.x+this.position.x,n=r.y+this.position.y):(t=r.xCenter,n=r.yMiddle),this.wrapper=e.text(t,n,this.get("text")).attr({fill:"black","font-size":12}).attr(this.get("attr")),this.wrapper.toFront(),this.wrapper.controller=this,_.each(this.get("children"),function(e){e.render()}),this.center(),this.editable&&this.asEditable(),this},y.prototype.resize=function(e,t,n){var r=this.parent.wrapper.getABox(),i=this.wrapper.getABox();this.center(),(n==="nw"||n==="ne")&&this.attr("y",this.wrapper.oy+t)},y.prototype.center=function(){var e=this.parent.wrapper.getABox(),t=this.wrapper.getABox();switch(this.position){case"center":this.attr("x",e.xCenter),this.attr("y",e.yMiddle);break;case"center-left":this.attr("x",e.x+this.xOffset+t.width/2),this.attr("y",e.yMiddle);if(this.image){var n=this.attr("x");this.attr({x:n+this.image.attr("width")})}break;case"center-right":this.attr("x",e.xRight-this.xOffset-t.width/2),this.attr("y",e.yMiddle);break;case"top-center":this.attr("x",e.xCenter),this.attr("y",e.y+t.height/2+this.yOffset);break;case"top-left":this.attr("x",e.x+t.width/2+this.xOffset),this.attr("y",e.y+t.height/2+this.yOffset);break;case"top-right":this.attr("x",e.xRight-this.xOffset-t.width/2),this.attr("y",e.y+t.height/2+this.yOffset);break;case"bottom-center":this.attr("x",e.xCenter),this.attr("y",e.yBottom-t.height/2-this.yOffset);break;case"bottom-left":this.attr("x",e.x+this.xOffset+t.width/2),this.attr("y",e.yBottom-t.height/2-this.yOffset);break;case"bottom-right":this.attr("x",e.x-this.xOffset-t.width/2),this.attr("y",e.yBottom-t.height/2-this.yOffset);break;default:}this.image&&(t=this.wrapper.getABox(),this.image.attr({x:t.x-this.image.attr("width")}),this.image.attr({y:t.y}))},y.prototype.setText=function(e){this.set("text",e),this.wrapper&&(this.wrapper.attr("text",e),this.center()),this.trigger("change:text",this)},y.prototype.getText=function(){return this.get("text")},y.prototype.remove=function(){this.image&&this.image.remove(),this.wrapper&&this.wrapper.remove()},y.prototype.asEditable=function(){var e=this;if(!e.wrapper)return;var t=function(e){var t=e.wrapper.getABox(),n=e.parent.wrapper.getABox(),r=e.diagram.el().offsetLeft,i=e.diagram.el().offsetTop,s=n.x+(isNaN(r)?0:r),o=n.y+(isNaN(i)?0:i),u=e.parent.attr("width"),a=20,f=this.textForm=document.createElement("form");f.setAttribute("style","position: absolute; left: "+s+"px; top: "+o+"px;");var l=document.createElement("input");return l.setAttribute("type","text"),l.setAttribute("placeholder",e.get("text")),l.setAttribute("style","padding: 0; width:"+u+"px; height: "+a+"px; z-index: 1;"),f.appendChild(l),{form:f,input:l}},n=function(e){e&&e.parentNode&&e.parentNode.removeChild(e)};e.wrapper.dblclick(function(r){var i=e.diagram.modifiedLabel;i&&i!==e&&(n(e.diagram.inputText),n(e.diagram.modifiedLabel.textForm)),e.textForm&&n(e.textForm);var s=t(e);e.textForm=s.form,e.diagram.inputText=s.input,e.diagram.modifiedLabel=e,e.diagram.el().parentNode.appendChild(s.form)})};var b=Diagram.Shape=function(e){if(!this.figure)throw new Error("Figure is not specified.");e||(e={}),this.attributes={},this.attributes.children=[],this.parent=e.parent||undefined,this.diagram=this.parent?this.parent.diagram:e.diagram,this.isConnectable=!0,this.shadow=this.shadow||!1,this.resizable!=null||(this.resizable=!0),this.draggable!=null||(this.draggable=!0),this.toolbox!=null||(this.toolbox=!0),this.inEdges=[],this.outEdges=[],this.set("type",this.type),e.id?this.set("id",e.id):this.set("id",_.uniqueId()),this.set("attr",_.clone(this.figure)),_.extend(this.get("attr"),this._attr(e)),this.initChildren(e.children),this.initialize.apply(this,arguments)};b.extend=a,_.extend(b.prototype,Diagram.SVGElement.prototype,Diagram.Draggable.prototype,Diagram.Selectable,s),b.prototype.toJSON=function(){var e=_.clone(this.attributes);return this.wrapper&&(e.attr=this.wrapper.attr()),e},b.prototype.disconnect=function(e){this.inEdges=_.without(this.inEdges,e),this.outEdges=_.without(this.outEdges,e)},b.prototype.initialize=function(e){},b.prototype.initChildren=function(e){if(e&&e.length>0)_.each(e,function(e){var t=null,n=e.attributes?e.toJSON():e;n.type==="Diagram.Label"?t=this.createLabel(n):n.type==="Diagram.Compartment"&&(t=this.createCompartment(n)),t&&this.get("children").push(t)},this);else{if(this.label){var t=this.createLabel(this.label);this.get("children").push(t)}this.compartments&&_.each(this.compartments,function(e){var t=this.createCompartment(e);this.get("children").push(t)},this)}},b.prototype.createLabel=function(e){return e.parent=this,new y(e)},b.prototype.createCompartment=function(e){return e.parent=this,new w(e)},b.prototype.render=function(){if(!this.diagram)throw new Error("Shape does not belong to a diagram");var e=this.paper();try{this.wrapper=this._createFigure()}catch(t){return console.log(t.message),this}return this.wrapper.controller=this,this.shadow&&this.createShadow(),this.draggable&&this.asDraggable(),this.toolbox&&(this._tool=new Diagram.ToolBox({element:this})),_.each(this.get("children"),function(e){e.render()}),this.wrapper.click(this.handleClickEvent),this.wrapper.mouseover(this.handleMouseOver),this.wrapper.mouseout(this.handleMouseOut),this},b.prototype.createShadow=function(){var e=this.wrapper.getABox(),t=this.paper();return this.shadowWrapper=t.rect(e.x,e.y,e.width,e.height,0).attr({fill:"grey",opacity:.2}).translate(4,4),this.shadowWrapper.toBack(),this},b.prototype.handleClickEvent=function(e){var t=this.controller.diagram,n=this.controller;n.select();if(t.canConnect(n)){var r=t.connect(n);console.log(r),r&&r.render()}},b.prototype.handleMouseOver=function(e){this.controller._tool&&this.controller._tool.render()},b.prototype.handleMouseOut=function(e){var t=this.controller;window.setTimeout(function(){t._tool&&(t._tool.isOver||t._tool.remove())},500)},b.prototype.resize=function(e,t,n){if(this.parent&&this.parent instanceof Diagram.Compartment){if(this.parent.layout==="stack"){var r=this.attr("height");this.attr(this.wrapper.rdxy(e,t<0?t:t,n)),this.attr({height:r})}}else this.resizable&&this.attr(this.wrapper.rdxy(e,t,n));if(this.has("children")){var i=this.get("children");if(i&&i.length)for(var s=0;s<i.length;s++){var o=i[s];typeof o.resize=="function"&&o.resize(e,t,n)}}},b.prototype.getCompartments=function(){return _.filter(this.get("children"),function(e){return e instanceof Diagram.Compartment})},b.prototype.resizeCompartments=function(){var e=this.getCompartments(),t=_.reduce(e,function(e,t){return e+t.attr("height")},0);_.each(e,function(t){t._resize();var n=_.indexOf(e,t);if(n+1<e.length){var r=e[n+1],i=r.attr("y"),s=t.attr("y")+t.height(),o=s-i;o>0&&r.move(0,s)}});var n=_.reduce(e,function(e,t){return e+t.attr("height")},0),r=n-t;if(r>0){var i=this.attr("height");this.attr({height:i+r})}},b.prototype.scale=function(e,t){this.wrapper.scale(e,t)},b.prototype.show=function(){this.wrapper&&this.wrapper.show(),this.hidder&&this.hidder.show(),this.resizer&&this.resizer.show(),_.each(this.get("children"),function(e){children.show()})},b.prototype.hide=function(){this.wrapper&&this.wrapper.hide(),this.hidder&&this.hidder.hide(),_.each(this.get("children"),function(e){e.hide()})},b.prototype.move=function(e,t){var n=this.attr("x"),r=this.attr("y");this.wrapper&&(e>0&&this.attr({x:e}),t>0&&this.attr({y:t})),_.each(this.get("children"),function(i){var s=i.attr("x"),o=i.attr("y"),u=e>0?s-n:0,a=t>0?o-r:0;i.move(e+u,t+a)})},b.prototype.remove=function(){_.each(this.get("children"),function(e){e.remove()}),_.each(this.selectionAnchors,function(e){e.remove()}),_.each(this.inEdges,function(e){e.trigger("remove:source",e)}),_.each(this.outEdges,function(e){e.trigger("remove:target",e)}),this.wrapper.remove(),this.shadow&&this.shadowWrapper.remove(),this._tool&&this._tool.remove(),this.trigger("remove",this)};var w=Diagram.Compartment=function(e){e||(e={}),this.attributes={},this.attributes.type="Diagram.Compartment",this.attributes.children=[],this.parent=e.parent||undefined,this.diagram=this.parent?this.parent.diagram:e.diagram,this.resizable=e.resizable||!0,this.draggable=e.draggable||!1,this.layout=e.layout||"none",this.set("layout",this.layout),this.top=e.top||0,this.set("top",this.top),e.accepts&&_.isArray(e.accepts)&&(this.accepts=e.accepts),this.set("accepts",this.accepts),this.set("attr",{}),this._cloneParentAttributes(),_.extend(this.get("attr"),this._attr(e)),this.initChildren(e.children),this.initialize.apply(this,arguments)};_.extend(w.prototype,Diagram.SVGElement.prototype,s),w.extend=a,w.prototype.initialize=function(){},w.prototype.initChildren=function(e){e&&e.length>0&&_.each(e,function(e){var t=null;if(e.type){var n=this.diagram._getConstructor(e.type);typeof n=="function"&&(e.parent=this,t=this.diagram.createShape(n,e),t&&this.addInner(t))}},this)},w.prototype._cloneParentAttributes=function(){if(this.parent){var e=this.parent.get("attr");for(var t in e)if(!_.isObject(e[t])||!_.isArray(e[t]))this.get("attr")[t]=e[t]}},w.prototype.render=function(){var e=this.paper();this.get("attr").width=this.parent.wrapper.attr("width"),this.get("attr").height||(this.get("attr").height=10);var t=this.get("attr").x=this.parent.attr("x"),n=this.get("attr").y=this.parent.attr("y")+this.top,r=this.get("attr").width,i=this.get("attr").height;return this.wrapper&&this.wrapper.remove(),this.parent.wrapper.type==="rect"&&(this.wrapper=e.rect(t,n,r,i,0).attr(this.get("attr"))),this.wrapper.controller=this,this.wrapper.toFront(),_.each(this.get("children"),function(e){e.render()}),this.wrapper.click(this.handleClickEvent),this},w.prototype.handleClickEvent=function(e){var n=this.controller;n.parent&&n.parent.select();var r=n.diagram.currentTool;if(r&&n.canCreate(r)){n.diagram.currentTool=null;var i=t.getMousePosition(n.paper(),e),s=n.createShape(r,i);s&&s.render()}},w.prototype.createShape=function(e,t){var n=null;return typeof e=="function"&&(t.parent=this,n=new e(t),n&&(this.addInner(n),this.trigger("add:children",n))),n},w.prototype.addInner=function(e){this.hidder&&this.hidder.toFront();var t=this.wrapper?this.wrapper.attr():this.get("attr"),n=this.get("children");if(this.wrapper&&this.layout==="stack"){e.get("attr").width=t.width;var r=_.last(n);if(r){var i=r.wrapper?r.wrapper.attr():r.get("attr"),s=i.y;s+=i.height,e.get("attr").x=t.x,e.get("attr").y=s}else e.get("attr").x=t.x,e.get("attr").y=t.y;n.push(e),this.parent.resizeCompartments()}else n.push(e)},w.prototype.resize=function(e,t,n){this.attr(this.wrapper.rdxy(e,t,n)),_.each(this.get("children"),function(r){r.resize(e,t,n)})},w.prototype._resize=function(){var e=this.height();e>0&&this.wrapper.attr({height:e})},w.prototype.height=function(){if(this.get("children").length>0){var e=_.reduce(this.get("children"),function(e,t){return e+t.get("attr").height},0);if(this.wrapper){var t=this.attr("height");if(t>=e)return t}return e}return this.wrapper?this.attr("height"):this.get("attr").height},w.prototype._addHidder=function(){var e,t,n;return e=this.position.x+2,t=this.position.y+2,n=this.paper(),n.rect(e,t,8,8,0).attr({fill:"whitesmoke",stroke:"none"})},w.prototype._hide=function(){currentY=this.wrapper.attr("y"),currentHeight=this.wrapper.attr("height"),this.wrapper.attr({height:this.get("attr").height}),_.each(this.get("children"),function(e){e.hide()}),this.positionNextCompartments(),this.hidder.hidden=!0},w.prototype._show=function(){this.position={x:this.parent.wrapper.attr("x"),y:this.parent.wrapper.attr("y")+this.top},this.resize(),this.positionNextCompartments(),_.each(this.get("children"),function(e){e.show()}),this.hidder.hidden=!1},w.prototype.positionNextCompartments=function(){var e=this.parent.compartments(),t=_.indexOf(e,this);for(var n=t+1;n<e.length;n++){var r=e[n],i=e[n-1],s=i.attr("y")+i.attr("height");r.attr({y:s})}},w.prototype.canCreate=function(e){if(this.accepts){var t=arguments[0],n=new e;if(n&&n.attributes){var r=_.find(this.accepts,function(e){return e===n.attributes.type});return r!==undefined}}return!1},w.prototype.remove=function(){_.each(this.get("children"),function(e){e.remove()}),this.wrapper&&this.wrapper.remove()},w.prototype.toJSON=function(){var e=_.clone(this.attributes);return this.wrapper&&(e.attr=this.wrapper.attr()),e};var E=function(e){return this.connection=e.connection,this.diagram=this.connection.diagram,this.attributes={},this};_.extend(E.prototype,Diagram.SVGElement.prototype),E.prototype.move=function(e){return this.x=e.x,this.y=e.y,this.wrapper&&this.wrapper.attr({x:this.x-2,y:this.y-2}),this},E.prototype.render=function(){if(this.wrapper)return this;var e=this.paper();return this.wrapper=e.rect(this.x-3,this.y-3,6,6),this.wrapper.attr({fill:"blue",stroke:"white"}),this.wrapper.anchor=this,this.asDraggable(),this},E.prototype.remove=function(){this.wrapper&&this.wrapper.remove()},E.prototype.asDraggable=function(){var e=function(e,t){this.attr({x:this.ox+e,y:this.oy+t}),this.anchor.connection.state="dragging",this.anchor.connection.dragger=this.anchor,this.anchor.connection.render()},t=function(){this.o(),this.anchor.shape.disconnect(this.anchor.connection)},n=function(){var e=this.paper,t=e.getElementsByPoint(this.attr("x"),this.attr("y")),n=_.find(t,function(e){return e!==this.anchor&&e.controller});n&&(this.anchor.shape=n.controller),this.anchor.connection.state=null;var r=this.anchor.connection.get("targetAnchor")===this.anchor;r?this.anchor.connection.connect(this.anchor.connection.get("sourceAnchor").shape,this.anchor.shape):this.anchor.connection.connect(this.anchor.shape,this.anchor.connection.get("targetAnchor").shape),this.anchor.connection.render()};return this.wrapper.drag(e,t,n),this},E.prototype.attach=function(e){return this.shape=e,this},E.prototype.toJSON=function(){return this.set("x",this.wrapper.x()),this.set("y",this.wrapper.y()),this._deepClone(this.attributes)};var S=function(e,t,n,r,i){this.paper=e,this.point=t,this.angle=n,this.radians=r,this.attributes={},this.attributes.attr={};if(i){this.attributes.type=i.type;var s=Raphael._availableAttrs;for(var o in i)_.has(s,o)&&(this.get("attr")[o]=i[o])}return this};_.extend(S.prototype,Diagram.Element.prototype,Diagram.SVGElement),S.prototype.remove=function(){this.wrapper&&this.wrapper.remove()},S.prototype.render=function(){var e=this.get("type");if(!e||e==="none")return this;var t;typeof Diagram.arrows[e]=="function"?t=Diagram.arrows[e](this.point):t=Diagram.arrows.basic(this.point);var n=this.point.x+ -2*(t.dx-1)*Math.cos(this.radians),r=this.point.y+2*(t.dy-1)*Math.sin(this.radians);return this.wrapper=this.paper.path(t.path.join(" ")),this.wrapper.attr(t.attr),this.wrapper.attr(this.get("attr")),this.wrapper.translate(n,r),this.wrapper.rotate(this.angle),this};var x=Diagram.ConnectionLabel=function(e){e||(e={});if(!e.connection)throw new Error("ConnectionLabel must have a parent Connection");return this.connection=e.connection,this.diagram=this.connection.diagram,this.position=e.position,this.attributes={},this.attributes.text=e.text,this.attributes.attr={},this};_.extend(x.prototype,Diagram.SVGElement.prototype,s),x.prototype.remove=function(){this.wrapper&&this.wrapper.remove()},x.prototype.render=function(){this.wrapper&&this.wrapper.remove();var e=this.paper(),t=this.connection,n=this.wrapper=e.text(0,0,this.get("text")),r=function(e,t,n,r){var i=t.xCenter<n,s=t.yMiddle>r,o=e.getBBox(),u=i?10+o.width/2:10-o.width,a=s?-10:10;return{x:n+u,y:r+a}},i=function(){var e=t.get("targetAnchor"),i=e.shape.wrapper.getABox(),s=e.wrapper.getABox(),o=s.xCenter,u=s.yMiddle,a=Math.sqrt(o*o+u*u),f=Math.atan(u/o);return console.log(a,f),r(n,i,o,u)},s=function(){var e=t.get("sourceAnchor"),i=e.shape.wrapper.getABox(),s=e.wrapper.getABox(),o=s.xCenter,u=s.yMiddle;return r(n,i,o,u)},o=function(){var e=t.get("sourceAnchor"),n=t.get("targetAnchor"),r=e.wrapper.getABox(),i=n.wrapper.getABox(),s=r.xCenter,o=r.yMiddle,u=i.xCenter,a=i.yMiddle,f=(s+u)/2,l=(o+a)/2;return l-=10,{x:f,y:l}},u;switch(this.position){case"start":u=s();break;case"end":u=i();break;default:u=o()}return this.wrapper.transform(["t",u.x,",",u.y].join("")),this.asEditable().asDraggable(),this},x.prototype.setText=function(e){this.set("text",e),this.wrapper&&this.wrapper.attr("text",e)},x.prototype.asDraggable=function(){var e=function(){this.o()},t=function(){},n=function(e,t,n,r,i){var s=this.ox+e,o=this.oy+t;this.attr({x:s,y:o})};return this.wrapper&&(this.wrapper.attr({cursor:"move"}),this.wrapper.drag(n,e,t)),this},x.prototype.asEditable=function(){var e=this,t=this.connection.diagram;if(!e.wrapper)return;var n=function(e){var t=e.wrapper.getABox(),n=e.connection.diagram,r=n.el().offsetLeft,i=n.el().offsetTop,s=t.x+(isNaN(r)?0:r),o=t.y+(isNaN(i)?0:i),u=t.width+20,a=20,f=document.createElement("form");f.setAttribute("style","position: absolute; left: "+s+"px; top: "+o+"px;");var l=document.createElement("input");return l.setAttribute("type","text"),l.setAttribute("placeholder",e.wrapper.attr("text")),l.setAttribute("style","padding: 0; width:"+u+"px; height: "+a+"px; z-index: 1;"),f.appendChild(l),{form:f,input:l}},r=function(e){e&&e.parentNode&&e.parentNode.removeChild(e)};return e.wrapper.dblclick(function(i){var s=t.modifiedLabel;s&&s!==e&&(r(t.inputText),r(t.modifiedLabel.textForm)),e.textForm&&r(e.textForm);var o=n(e);e.textForm=o.form,t.inputText=o.input,t.modifiedLabel=e,t.el().parentNode.appendChild(o.form)}),this};var T=Diagram.Connection=function(e){if(!e.diagram)throw new Error("Connection cannot be initialized, diagram property missing.");this.diagram=e.diagram,this.attributes={},this.attributes.children=[],this.attributes.attr={},this.set("type",this.type),e.id?this.set("id",e.id):this.set("id",_.uniqueId());var t=Raphael._availableAttrs;for(var n in this)_.has(t,n)&&(this.get("attr")[n]=this[n]);_.extend(this.get("attr"),this._attr(e)),this.set("sourceAnchor",new E({connection:this})),this.set("targetAnchor",new E({connection:this})),this.initChildren(e.children),this.initialize.apply(this,arguments)};T.extend=a,_.extend(Diagram.Connection.prototype,Diagram.SVGElement.prototype,s),T.prototype.initialize=function(){},T.prototype.initChildren=function(e){if(!e||!e.length)if(this.label){var t=_.isArray(this.label)?this.label:[this.label];_.each(t,function(e){var t=this.createLabel(e);this.get("children").push(t)},this)}},T.prototype.createLabel=function(e){return e.connection=this,new x(e)},T.prototype.createConnection=function(){var e=[],t=this.paper();return con=t.path(this.paths.join(" ")),this.has("attr")&&con.attr(this.get("attr")),con},T.prototype.remove=function(){this.wrapper&&this.wrapper.remove(),this.startArrow&&this.startArrow.remove(),this.endArrow&&this.endArrow.remove(),this.dummy&&this.dummy.remove(),_.each(this.get("children"),function(e){e.remove()})},T.prototype.render=function(){var e,t,r=this.paper();this.state&&this.state==="dragging"?this.dragger===this.get("sourceAnchor")?(e=this.get("sourceAnchor").wrapper.getABox(),t=this.get("target").wrapper.getABox()):(e=this.get("source").wrapper.getABox(),t=this.get("targetAnchor").wrapper.getABox()):(e=this.get("source").wrapper.getABox(),t=this.get("target").wrapper.getABox());var i=new n(r,e.center,t.center),s=i.findIntersection(e),o=i.findIntersection(t);i.remove();if(!s||!o)return;this.remove();var u=C(e.center,t.center),a=360-u.degrees+180,f=360-u.degrees;this.paths=N(s,o,[],!1),this.wrapper=this.createConnection(),this.wrapper.toFront(),this.startArrow=new S(r,s,a,u.radians,this.start),this.startArrow.render(),this.endArrow=new S(r,o,f,u.radians,this.end),this.endArrow.render(),this.get("sourceAnchor").move(s).render().hide(),this.get("targetAnchor").move(o).render().hide(),this.dummy=new n(r,s,o),this.dummy.attr({opacity:0,"stroke-width":12}),_.each(this.get("children"),function(e){e.render()});var l=this;return this.dummy.wrapper.click(function(e){l.get("sourceAnchor").toFront().show(),l.get("targetAnchor").toFront().show(),l.diagram.selected&&l.diagram.selected.deselect()}),this},T.prototype.connect=function(e,t){return this.set("source",e),this.set("target",t),this.get("sourceAnchor").attach(e),this.get("targetAnchor").attach(t),e.trigger("connect:source",this),t.trigger("connect:target",this),e.outEdges.push(this),t.inEdges.push(this),this},T.prototype.disconnect=function(){console.log("disconnect");var e=this.get("source"),t=this.get("target");return e.outEdges=_.reject(e.outEdges,function(e){return e===this},this),t.inEdges=_.reject(t.inEdges,function(e){return e===this},this),this.set("source",null),this.set("target",null),this},T.prototype.toJSON=function(){var e={};return e.source=this.get("source").get("id"),e.target=this.get("target").get("id"),e.type=this.get("type"),e.id=this.get("id"),e.sourceAnchor=this.get("sourceAnchor"),e.targetAnchor=this.get("targetAnchor"),e.x=this.get("x"),e.y=this.get("y"),this.wrapper&&(e.attr=this.wrapper.attr()),e};var k=Diagram.Palette=function(e){this.diagram=e,this.paletteX=0,this.paletteY=0};k.extend=a;var L=["<% _.each(groups, function(group) { %>",'<div class="accordion-group">','<div class="accordion-heading"><a class="accordion-toggle" data-toggle="collapse" data-parent="#accordion" href="#collapse<%= group.title %>"><%= group.title %></a></div>','<div id="collapse<%= group.title %>" class="accordion-body in collapse" style="height: auto;">','<div class="accordion-inner">','<div class="btn-group-vertical">',"<% _.each(group.tools, function(tool) { %>",'<button id="create<%= tool.title %>" class="btn palette-tool"><i class="icon-tool-<%= tool.title %>"></i> <%= tool.title %></button>',"<% }) %>","</div>","</div>","</div>","</div>","<% }) %>"],A=_.template(L.join(" "));k.prototype.render=function(){return this.paletteRoot?this:(this.paletteRoot=document.createElement("div"),this.paletteRoot.setAttribute("class","palette"),this.paletteHeader=document.createElement("div"),this.paletteHeader.setAttribute("class","palette-header"),this.paletteGroups=document.createElement("div"),this.paletteGroups.setAttribute("class","palette-groups"),this.paletteGroups.innerHTML=A(this),this.paletteRoot.appendChild(this.paletteHeader),this.paletteRoot.appendChild(this.paletteGroups),this.diagram.el().parentNode.appendChild(this.paletteRoot),this.addEvents(),this)},k.prototype.el=function(){return this.paletteRoot},k.prototype.addEvents=function(){var e=this;_.each(this.groups,function(t){_.each(t.tools,function(t){var n=document.getElementById("create"+t.title);n&&typeof t.shape=="function"&&n.addEventListener("click",function(n){e.diagram.currentTool=t.shape}),n&&typeof t.edge=="function"&&n.addEventListener("click",function(n){e.diagram.currentEdge=t.edge})})})},k.prototype.asDraggable=function(){if(this.paletteRoot){this.paletteHeader.style.cursor="move";var e=this;e._moving=!1,this.paletteHeader.addEventListener("mousedown",function(t){e._moving=!0,e.offsetX=t.pageX-e.paletteX,e.offsetY=t.pageY-e.paletteY}),this.diagram.el().parentNode.addEventListener("mouseup",function(t){e._moving=!1}),this.diagram.el().parentNode.addEventListener("mousemove",function(t){e._moving&&(e.paletteX=t.pageX-e.offsetX,e.paletteY=t.pageY-e.offsetY,e.paletteRoot.style.left=e.paletteX+"px",e.paletteRoot.style.top=e.paletteY+"px")})}},k.prototype.remove=function(){this.paletteRoot&&(this.paletteRoot.parentNode.removeChild(this.paletteRoot),this.paletteRoot=null)};var O=Diagram.PropertyBox=function(e){return e||(e={}),this.diagram=e.diagram,this.x=e.x,this.y=e.y,this.width=e.width?e.width:340,this.height=e.height?e.height:200,this};O.prototype.render=function(){if(this.root)return this;this.root=document.createElement("div"),this.root.setAttribute("class","property-box"),this.header=document.createElement("div"),this.header.setAttribute("class","property-box-header"),this.body=document.createElement("div"),this.body.setAttribute("class","property-box-body"),this.root.appendChild(this.header),this.root.appendChild(this.body);var e=document.createElement("a");e.setAttribute("style","position: relative; font-size: 12px; color: black;"),e.style.left=this.width-16+"px",e.style.cursor="default",e.innerHTML="X",this.header.appendChild(e);var t=this;return e.addEventListener("click",function(e){t.remove()}),typeof O.bodyTemplate=="function"&&(this.body.innerHTML=O.bodyTemplate()),this.root.style.left=this.x+"px",this.root.style.top=this.y+"px",this.diagram.el().appendChild(this.root),this.asDraggable(),this},O.prototype.asDraggable=function(){if(this.root){this.header.style.cursor="move";var e=this;e._moving=!1,this.header.addEventListener("mousedown",function(t){e._moving=!0,e.offsetX=t.pageX-e.x,e.offsetY=t.pageY-e.y}),this.diagram.el().addEventListener("mouseup",function(t){e._moving=!1}),this.diagram.el().addEventListener("mousemove",function(t){e._moving&&(e.x=t.pageX-e.offsetX,e.y=t.pageY-e.offsetY,e.root.style.left=e.x+"px",e.root.style.top=e.y+"px")})}},O.prototype.remove=function(){this.root&&(this.diagram.el().removeChild(this.root),this.root=null)},Diagram.ToolBox.propertyBox=O})();