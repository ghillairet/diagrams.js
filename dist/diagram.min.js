(function(){function x(){var e=this,t=e.controller;e.o(),t&&(typeof t.deselect=="function"&&t.deselect(),t.shadow&&t.shadowWrapper.remove(),t._tool&&t._tool.remove(),e.unmouseover(t.mouseover),e.unmouseout(t.mouseout),t.startdragging())}function T(e,t,n,r,i){var s=this,o=s.getBBox(),u=s.ox+e,a=s.oy+t,f=s.is("circle")||s.is("ellipse")?o.width/2:0,l=s.paper,c=s.controller,h;u=Math.min(Math.max(f,u),l.width-(s.is("circle")||s.is("ellipse")?f:o.width)),a=Math.min(Math.max(f,a),l.height-(s.is("circle")||s.is("ellipse")?f:o.height)),h={x:u,y:a,cx:u,cy:a},s.attr(h),c&&c._renderEdges()}function N(){var e=this,t=e.controller;C(e),t&&(e.mouseover(t.mouseover),e.mouseout(t.mouseout),t.get("attr").x=e.x(),t.get("attr").y=e.y(),t._renderContent(),t.shadow&&t.createShadow())}function C(e){var t=e.oa;t.width=e.attrs.width,t.height=e.attrs.height,t.r=e.attrs.r,t.cx=e.attrs.cx,t.cy=e.attrs.cy,t.x=e.attrs.x,t.y=e.attrs.y,e.attr(t),delete e.oa}function D(e,t,n,r){var i=["M",e.x,e.y],s=0,o=n.length;for(;s<o;s++)i.push("L",n[s].x,n[s].y);return i.push("L",t.x,t.y),i}function P(e,t){var n=-(t.y-e.y),r=t.x-e.x,i=Math.atan2(n,r);return i<0&&(i=2*Math.PI+i),{degrees:180*i/Math.PI,radians:i}}var e=this;e.Diagram=Diagram={version:"0.0.1"};var t=function(t,n){var r;n===undefined?(r=t.split(t.indexOf("@")===-1?" ":"@"),this.x=parseInt(r[0],10),this.y=parseInt(r[1],10)):(this.x=t,this.y=n)};t.getMousePosition=function(e,n){if(window.event&&window.event.contentOverflow!==undefined)return new t(window.event.x,window.event.y);if(n.offsetX!==undefined&&n.offsetY!==undefined)return new t(n.offsetX,n.offsetY);var r=n.pageX,i=n.pageY,s=e.canvas.parentNode,o=s?s.offsetLeft:0,u=s?s.offsetTop:0,a=s?s.offsetParent:0,f=r-o,l=i-u;while(a)f+=a.offsetLeft,l+=a.offsetTop,a=a.offsetParent;return new t(f,l)};var n=function(e,t,n){return this.paper=e,this.start=t,this.end=n,this.wrapper=e.path("M"+this.start.x+","+this.start.y+"L"+this.end.x+","+this.end.y),this};n.prototype.attr=function(){return Raphael.el.attr.apply(this.wrapper,arguments)},n.prototype.remove=function(){this.wrapper.remove()},n.prototype.intersection=function(e){var t={x:this.end.x-this.start.x,y:this.end.y-this.start.y},n={x:e.end.x-e.start.x,y:e.end.y-e.start.y},r=t.x*n.y-t.y*n.x,i={x:e.start.x-this.start.x,y:e.start.y-this.start.y},s=i.x*n.y-i.y*n.x,o=i.x*t.y-i.y*t.x;if(r===0||s*r<0||o*r<0)return null;if(r>0){if(s>r||o>r)return null}else if(s<r||o<r)return null;return{x:this.start.x+s*t.x/r,y:this.start.y+s*t.y/r}},n.prototype.findIntersection=function(e){var t=[{p1:e.topLeft,p2:e.topRight},{p1:e.topLeft,p2:e.bottomLeft},{p1:e.bottomLeft,p2:e.bottomRight},{p1:e.bottomRight,p2:e.topRight}];for(var r=0;r<t.length;r++){var i=new n(this.paper,t[r].p1,t[r].p2),s=this.intersection(i);i.remove();if(s)return s}return null};var r=function(e){return _.isNumber(e)&&_.isFinite(e)?e>0:!1};Raphael.el.is=function(e){return this.type===e},Raphael.el.x=function(){switch(this.type){case"ellipse":case"circle":return this.attr("cx");default:return this.attr("x")}},Raphael.el.y=function(){switch(this.type){case"ellipse":case"circle":return this.attr("cy");default:return this.attr("y")}},Raphael.el.rdxy=function(e,t,n){switch(this.type){case"ellipse":if(n==="ne"||n==="nw")t=-t;if(n==="nw"||n==="sw")e=-e;var i=this.orx+e,s=this.orx+t;return{rx:r(i)?i:this.orx,ry:r(s)?s:this.ory};case"circle":if(n==="ne"||n==="nw")t=-t;var o=this.or+(t<0?-1:1)*Math.sqrt(2*t*t);return{r:r(o)?o:this.or};case"rect":var u=this.ow+e;if(n==="nw"||n==="sw")u=this.ow-e;var a=this.oh+t;if(n==="ne"||n==="nw")a=this.oh-t;var f=this.oy,l=this.ox;if(n==="sw"||n==="nw")l=this.ox+e;if(n==="ne"||n==="nw")f=this.oy+t;return{width:r(u)?u:this.ow,height:r(a)?a:this.oh,y:f,x:l};default:return{}}},Raphael.el.o=function(){var e=this.attr();return this.ox=this.x(),this.oy=this.y(),this.ow=e.width,this.oh=e.height,this.or=e.r,this.orx=e.rx,this.ory=e.ry,this},Raphael.el.getABox=function(){var e=this.getBBox(),t={x:e.x,y:e.y,width:e.width,height:e.height,xLeft:e.x,xCenter:e.x+e.width/2,xRight:e.x+e.width,yTop:e.y,yMiddle:e.y+e.height/2,yBottom:e.y+e.height};return t.center={x:t.xCenter,y:t.yMiddle},t.topLeft={x:t.xLeft,y:t.yTop},t.topRight={x:t.xRight,y:t.yTop},t.bottomLeft={x:t.xLeft,y:t.yBottom},t.bottomRight={x:t.xRight,y:t.yBottom},t.top={x:t.xCenter,y:t.yTop},t.bottom={x:t.xCenter,y:t.yBottom},t.left={x:t.xLeft,y:t.yMiddle},t.right={x:t.xRight,y:t.yMiddle},t},Raphael.fn.polyline=function(e,t){var n=["M",e,t,"L"];for(var r=2;r<arguments.length;r++)n.push(arguments[r]);return this.path(n.join(" "))};var i=/\s+/,s=Diagram.Events={on:function(e,t,n){var r,s,o;if(!t)return this;e=e.split(i),r=this._callbacks||(this._callbacks={});while(s=e.shift())o=r[s]||(r[s]=[]),o.push(t,n);return this},off:function(e,t,n){var r,s,o,u;if(!(s=this._callbacks))return this;if(!(e||t||n))return delete this._callbacks,this;e=e?e.split(i):_.keys(s);while(r=e.shift()){if(!(o=s[r])||!t&&!n){delete s[r];continue}for(u=o.length-2;u>=0;u-=2)t&&o[u]!==t||n&&o[u+1]!==n||o.splice(u,2)}return this},trigger:function(e){var t,n,r,s,o,u,a,f;if(!(n=this._callbacks))return this;f=[],e=e.split(i);for(s=1,o=arguments.length;s<o;s++)f[s-1]=arguments[s];while(t=e.shift()){if(a=n.all)a=a.slice();if(r=n[t])r=r.slice();if(r)for(s=0,o=r.length;s<o;s+=2)r[s].apply(r[s+1]||this,f);if(a){u=[t].concat(f);for(s=0,o=a.length;s<o;s+=2)a[s].apply(a[s+1]||this,u)}}return this}},o=this.Backbone;o&&(s=o.Events),Diagram.arrows={none:function(e){return e||(e=2),{path:"M"+e+",0L"+ -e+",0",dx:e,dy:e,attr:{opacity:0}}},basic:function(e,t){return t||(t=4),{path:["M",t.toString(),"0","L",(-t).toString(),(-t).toString(),"L",(-t).toString(),t.toString(),"z"],dx:t,dy:t,attr:{stroke:"black",fill:"black"}}}};var u=Diagram.Element=function(e){this.attributes={},this.attributes.children=[],this.parent=e.parent||undefined,this.diagram=this.parent?this.parent.diagram:e.diagram},a=function(e,t){return l(this,e,t)},f=function(){},l=function(e,t,n){var r;return t&&t.hasOwnProperty("constructor")?r=t.constructor:r=function(){e.apply(this,arguments)},_.extend(r,e),f.prototype=e.prototype,r.prototype=new f,t&&_.extend(r.prototype,t),n&&_.extend(r,n),r.prototype.constructor=r,r.__super__=e.prototype,r};u.extend=a,u.prototype={has:function(e){return this.attributes[e]!==null},get:function(e){return this.attributes[e]},set:function(e,t){this.attributes[e]=t},render:function(){},paper:function(){if(!this.diagram)throw new Error("SVGElement must be associated to a diagram");return this.diagram.paper()},attr:function(){return Raphael.el.attr.apply(this.wrapper,arguments)},toJSON:function(){var e=this.attributes,t=_.clone(e);return this._deepClone(t)},_deepClone:function(e){for(var t in e){var n=e[t];if(_.isArray(n)){var r=[];for(var i=0;i<n.length;i++){var s=n[i];s.attributes&&(r[i]=s.toJSON())}e[t]=r}else _.isObject(n)&&n.attributes&&(e[t]=n.toJSON())}return e},_attr:function(e){var t=Raphael._availableAttrs,n;e.attr?n=_.clone(e.attr):n={};for(var r in e)_.has(t,r)&&(n[r]=e[r]);return n}};var c=Diagram.DiagramElement=u.extend({constructor:function(e){Diagram.Element.apply(this,[e]),this.parent=e.parent||undefined,this.diagram=this.parent?this.parent.diagram:e.diagram},attr:function(){return Raphael.el.attr.apply(this.wrapper,arguments)},_attr:function(e){var t=Raphael._availableAttrs,n;e.attr?n=_.clone(e.attr):n={};for(var r in e)_.has(t,r)&&(n[r]=e[r]);return n}});Diagram.SVGElement=function(){},_.extend(Diagram.SVGElement.prototype,Diagram.Element.prototype,{paper:function(){if(!this.diagram)throw new Error("SVGElement must be associated to a diagram");return this.diagram.paper()},getX:function(){return this.wrapper?this.wrapper.attr("x"):this.get("attr").x},getY:function(){return this.wrapper?this.wrapper.attr("y"):this.get("attr").y},show:function(){return this.wrapper.show()},hide:function(){return this.wrapper.hide()},toFront:function(){return this.wrapper.toFront()},attr:function(){return Raphael.el.attr.apply(this.wrapper,arguments)},_get:function(e){var t;return this.attributes.attr?t=this.attributes.attr[e]?this.attributes.attr[e]:this.figure[e]:t=this.figure[e],isNaN(t)?0:t},_attr:function(e){var t=Raphael._availableAttrs,n=e.attr||{};for(var r in e)_.has(t,r)&&(n[r]=e[r]);return n},_rect:function(){var e=this._get("x"),t=this._get("y"),n=this._get("width"),r=this._get("height"),i=this._get("r"),s=this.get("attr");return this.paper().rect(e,t,n,r,i).attr(s)},_circle:function(){var e=this._get("x"),t=this._get("y"),n=this._get("r"),r=this.get("attr");return e===0&&(e=this._get("cx")),t===0&&(t=this._get("cy")),delete r.x,delete r.y,this.paper().circle(e,t,n).attr(r)},_ellipse:function(){var e=this._get("x"),t=this._get("y"),n=this._get("rx"),r=this._get("ry"),i=this.get("attr");return this.paper().ellipse(e,t,n,r).attr(i)},_path:function(){var e=this._get("path"),t=this.get("attr");return this.paper().path(e).attr(t)},draw:function(e,t){if(!e||!e.type)return;var n=e.type,r=this._get("x"),i=this._get("y"),s;switch(n){case"rect":s=this.paper().rect(r,i);break;case"circle":s=this.paper().circle(r,i);break;case"ellipse":s=this.paper().ellipse(r,i);break;case"path":s=this.paper().path(e.path);break;default:s=null}if(s){s.attr(e);if(t){var o=t.getABox();s.translate(o.topLeft.x,o.topLeft.y)}e.figure&&(s._child=this.draw(e.figure,s),s._child._parent=s)}return s},drawContent:function(){var e=this.figure;this.wrapper&&e.figure&&(this.wrapper._child=this.draw(e.figure,this.wrapper))},_remove:function(){var e=function(t){t&&(t._child&&e(t._child),t.remove())};this.wrapper&&e(this.wrapper)},_createFigure:function(){var e,t=this.figure;e=this.draw(t);if(!e)throw new Error("Cannot create figure for "+this);return e}}),Diagram.Diagram=function(e){return e||(e={}),this.container&&this.setElement(this.container),this.attributes={name:"",type:"",children:[],edges:[]},_.isObject(e)&&_.each(_.keys(e),function(t){this.attributes[t]=e[t]},this),this.type&&this.set("type",type),e.id?this.set("id",e.id):this.set("id",_.uniqueId()),this.currentSource=null,this.currentEdge=null,this.initialize(e),this},Diagram.Diagram.extend=a,_.extend(Diagram.Diagram.prototype,Diagram.Element.prototype,s),Diagram.Diagram.prototype.initialize=function(){},Diagram.Diagram.prototype.setElement=function(e){if(!e)return this;if(_.isString(e)){var t=e.indexOf("#")===0?e.slice(1,e.length):e;this._el=document.getElementById(t)}else e instanceof HTMLElement&&(this._el=el);return this},Diagram.Diagram.prototype.el=function(){return this._el},Diagram.Diagram.prototype.paper=function(e){return e&&(this._paper=e),this._init(),this._paper},Diagram.Diagram.prototype._init=function(){this._paper||(this._paper=Raphael(this._el,this.width,this.height),console.log(this._paper.width,this._paper.height),this._paper.setViewBox(0,0,this._paper.width,this._paper.height)),this.canvas().addEventListener("click",this)},Diagram.Diagram.prototype.render=function(){return this._init(),_.each(this.get("children"),function(e){e.render()}),_.each(this.get("edges"),function(e){e.render()}),this},Diagram.Diagram.prototype.zoom=function(e){var t=this._paper;console.log("zoom"),t.setViewBox(0,0,t.width/2,t.height/2)},Diagram.Diagram.prototype.canvas=function(){return this._paper?this._paper.canvas:null},Diagram.Diagram.prototype.remove=function(){this._paper&&(_.each(this.get("children"),function(e){e.remove()}),_.each(this.get("edges"),function(e){e.remove()}),this._paper.remove(),this._paper=null)},Diagram.Diagram.prototype.createShape=function(e,t){var n=null;if(!e)throw new Error("Cannot create Shape if Shape constructor is missing");return t.diagram=this,n=new e(t),n},Diagram.Diagram.prototype.removeShape=function(e){if(e){var t=this.get("children");this.set("children",_.reject(t,function(t){return t===e})),this.trigger("remove:children",e)}},Diagram.Diagram.prototype.getShape=function(e){var t=_.find(this.get("children"),function(t){var n=t.get("id");if(n)return n===e});return t},Diagram.Diagram.prototype.createConnection=function(e,t){var n=null;if(typeof e=="function"){n=new e({diagram:this});if(t){var r=t.source,i=t.target;r&&i&&n.connect(r,i)}n.on("remove:source remove:target",function(e){this.removeConnection(e)},this)}return n},Diagram.Diagram.prototype.removeConnection=function(e){if(e){var t=this.get("edges");this.set("edges",_.reject(t,function(t){return t===e})),this.trigger("remove:edges",e)}},Diagram.Diagram.prototype.getConnection=function(e){var t=_.find(this.get("edges"),function(t){var n=t.get("id");if(n)return n===e});return t},Diagram.Diagram.prototype.canConnect=function(e){return this.currentEdge?this.currentSource?!0:(this.currentSource=e,!1):!1},Diagram.Diagram.prototype.connect=function(e){var t=null;return this.currentEdge&&this.currentSource&&(t=this.createConnection(this.currentEdge,{source:this.currentSource,target:e}),this.currentEdge=null,this.currentSource=null),t},Diagram.Diagram.prototype.handleTextInput=function(){var e=this.inputText.value;e&&(this.modifiedLabel.setText(e),this.modifiedLabel.textForm.parentNode.removeChild(this.modifiedLabel.textForm),this.modifiedLabel.textForm=null,this.modifiedLabel=null,this.inputText=null),this.repeatInputClick?this.modifiedLabel&&(this.modifiedLabel.textForm.parentNode.removeChild(this.modifiedLabel.textForm),this.modifiedLabel.textForm=null,this.modifiedLabel=null,this.inputText=null,this.repeatInputClick=!1):this.repeatInputClick=!0},Diagram.Diagram.prototype.handleEvent=function(e){var n=t.getMousePosition(this._paper,e),r=this._paper.getElementsByPoint(n.x,n.y);r.length===0&&this.selected&&this.selected.deselect(),this.inputText&&this.handleTextInput(),r.length===0&&this.currentEdge&&(this.currentEdge=null)},Diagram.Diagram.prototype._canCreate=function(e){var t=_.find(this.child,function(t){return t===e});return t!==undefined},Diagram.Diagram.prototype.load=function(e){e.name&&this.set("name",e.name),e.type&&this.set("type",e.type);var t=this.get("children");_.each(e.children,function(e){var n=this.loadShape(e);n&&t.push(n)},this);var n=this.get("edges");_.each(e.edges,function(e){var t=this.loadEdge(e);t&&n.push(t)},this)},Diagram.Diagram.prototype._getConstructor=function(e){var t=e.split("."),n=window;for(var r=0;r<t.length;r++)n=n[t[r]];return n},Diagram.Diagram.prototype.loadShape=function(e){if(!e.type)throw new Error("Cannot create Shape, type is undefined");var t=this._getConstructor(e.type);return typeof t=="function"?this.createShape(t,e):null},Diagram.Diagram.prototype.loadEdge=function(e,t){if(!e.type)throw new Error("Cannot create Edge, type is undefined");var n=this._getConstructor(e.type);if(typeof n=="function"){var r=t?t:this.get("children"),i=_.find(t,function(t){return t.get("id")==e.source}),s=_.find(t,function(t){return t.get("id")==e.target});if(i&&s){var o=new n({diagram:this});if(o)return o.connect(i,s),o}}return null};var h=Diagram.ToolBox=function(e){return this.element=e.element,this.diagram=this.element.diagram,this.width=40,this.height=20,this.children=[],this};_.extend(h.prototype,Diagram.SVGElement.prototype),h.prototype.render=function(){if(!this.element&&!this.element.wrapper)return;this.wrapper&&this.wrapper.remove();var e=this.paper(),t=this.element.wrapper.getABox(),n=t.xRight-this.width+4,r=t.y-this.height-4;this.wrapper=e.rect(n,r,this.width,this.height,6).attr({fill:"blue","fill-opacity":.4,stroke:"blue","stroke-opacity":.6,"stroke-width":2}),this.wrapper.controller=this,this.wrapper.mouseover(this.handleMouseOver),this.wrapper.mouseout(this.handleMouseOut),t=this.wrapper.getABox();var i=this;this.addItem(t.x+12,t.yMiddle,"X",function(e){i.element.remove()});var s=this.propertyBox=new h.propertyBox({diagram:i.diagram});return h.propertyBox&&this.addItem(t.xRight-12,t.yMiddle,"P",function(e){var t=i.element.wrapper.getABox();s.x=t.xRight+20,s.y=t.y,s.render()}),this},h.prototype.addItem=function(e,t,n,r){var i=this,s=this.paper(),o=s.text(e,t,n);return o.attr("cursor","pointer"),this.children.push(o),o.mouseover(function(e){i.isOverChild=!0}),o.mouseout(function(e){i.isOverChild=!1}),o.click(r),this},h.prototype.remove=function(){this.wrapper&&(this.wrapper.remove(),_.each(this.children,function(e){e.remove()}),this.children.length=0)},h.prototype.handleMouseOver=function(){this.controller.isOver=!0,this.controller.isOverChild=!1},h.prototype.handleMouseOut=function(){var e=this.controller;window.setTimeout(function(){e&&!e.isOverChild&&(e.isOver=!1,e.remove())},300)},Diagram.Selectable={select:function(){this.diagram.selected&&this.diagram.selected.deselect(),this.diagram.selected=this;if(this.wrapper){bbox=this.wrapper.getABox(),this.selectionAnchors=[];var e=(new m({box:this})).render(),t=(new d({box:this})).render(),n=(new v({box:this})).render(),r=(new g({box:this})).render();this.resizable&&(e.resizable(),t.resizable(),r.resizable(),n.resizable()),this.selectionAnchors.push(t),this.selectionAnchors.push(e),this.selectionAnchors.push(n),this.selectionAnchors.push(r)}},deselect:function(){this.selectionAnchors&&_.each(this.selectionAnchors,function(e){e.remove()})}};var p=function(e){this.box=e.box,this.diagram=this.box.diagram,this.initialize.apply(this,arguments)};p.cursor="",_.extend(p.prototype,Diagram.SVGElement.prototype),p.extend=a,p.prototype.initialize=function(e){},p.prototype.render=function(){var e=this.paper();return this.wrapper=e.rect(this.x,this.y,6,6,0).attr({fill:"blue",stroke:"blue","stroke-width":0,"fill-opacity":.6}),this.box.resizable&&this.wrapper.attr({cursor:this.cursor}),this.wrapper.box=this.box.wrapper,this.wrapper.anchor=this,this},p.prototype.remove=function(){this.wrapper&&this.wrapper.remove();if(this.box){var e=this.box;this.box=null,e.anchor&&delete e.anchor}},p.start=function(){this.o(),this.box.o();var e=this.anchor,t=this.box.controller;t.startresize(),t.shadow&&t.shadowWrapper.remove(),_.each(t.selectionAnchors,function(t){t!==e&&t.remove()})},p.move=function(e,t,n,r,i){this.attr({x:this.ox+e,y:this.oy+t});var s=this.box.controller;s&&s.resize(e,t,this.anchor.direction)},p.end=function(){var e=this.box.controller;e.endresize(),e.shadow&&e.createShadow(),this.anchor&&this.anchor.box.select()};var d=p.extend({initialize:function(e){var t=e.box.wrapper.getABox();this.x=t.x-3,this.y=t.y-3,this.cursor="nw-resize",this.direction="nw"},resizable:function(){return this.wrapper.drag(p.move,p.start,p.end),this}}),v=p.extend({initialize:function(e){var t=e.box.wrapper.getABox();this.x=t.xLeft-3,this.y=t.yBottom-3,this.cursor="sw-resize",this.direction="sw"},resizable:function(){return this.wrapper.drag(p.move,p.start,p.end),this}}),m=p.extend({initialize:function(e){var t=e.box.wrapper.getABox();this.x=t.xRight-3,this.y=t.y-3,this.cursor="ne-resize",this.direction="ne"},resizable:function(){return this.wrapper.drag(p.move,p.start,p.end),this}}),g=p.extend({initialize:function(e){var t=e.box.wrapper.getABox();this.x=t.xRight-3,this.y=t.yBottom-3,this.cursor="se-resize",this.direction="se"},resizable:function(){return this.wrapper.drag(p.move,p.start,p.end),this}}),y=Diagram.Image=function(e){return this.parent=e.parent,this.diagram=this.parent.diagram,this.attributes={},this.set("type","Diagram.Image"),this.set("width",e.width),this.set("height",e.height),this.set("src",e.src),this};_.extend(y.prototype,Diagram.SVGElement.prototype),y.prototype.render=function(){var e=this.paper(),t=this.parent.wrapper.getBBox(),n=this.get("src"),r=this.get("width"),i=this.get("height");return this.wrapper=e.image(n,t.x,t.y,r,i),this.wrapper.toFront(),this.wrapper.controller=this,this},y.prototype.center=function(){var e=this.parent.wrapper.getABox();this.wrapper.attr({x:e.x-this.get("width")}),this.wrapper.attr({y:e.yMiddle-this.get("height")/2})};var b=Diagram.Label=function(e){e||(e={}),this.attributes={},this.attributes.children=[],this.attributes.type="Diagram.Label",this._positions=["top-left","top-right","top-center","bottom-left","bottom-right","bottom-center","center-left","center-right","center"],this.parent=e.parent||undefined,this.diagram=this.parent?this.parent.diagram:e.diagram,this.position=this._getPosition(e),this.resizable=e.resizable||!1,this.draggable=e.draggable||!1,this.editable=e.editable||!0,e.id!==null?this.set("id",e.id):this.set("id",_.uniqueId()),this.xOffset=5,this.yOffset=5,this.set("attr",this._attr(e)),this.set("position",this.position),this._initChildren(e),e.width&&(this.width=e.width),e.height&&(this.height=e.height),e.text?this.set("text",e.text):this.set("text","Label")};_.extend(b.prototype,Diagram.SVGElement.prototype,Diagram.Draggable,s),b.prototype._getPosition=function(e){if(e.position){var t=e.position;if(t.x&&t.y)return t;if(_.include(this._positions,t))return t}return"center"},b.prototype._initChildren=function(e){var t=e.children;if(t&&t.length>0)_.each(t,function(e){if(e.type==="Diagram.Image"){var t=this.createImage(e);this.get("children").push(t)}},this);else if(e.image){var n=this.createImage(e.image);this.get("children").push(n)}},b.prototype.createImage=function(e){e.parent=this;var t=new Diagram.Image(e);return this.image=t,t},b.prototype.render=function(){var e=this.paper(),t,n,r=this.parent.wrapper.getABox();return this.position.x&&this.position.y?(t=r.x+this.position.x,n=r.y+this.position.y):(t=r.xCenter,n=r.yMiddle),this.wrapper=e.text(t,n,this.get("text")).attr({fill:"black","font-size":12}).attr(this.get("attr")),this.wrapper.toFront(),this.wrapper.controller=this,_.each(this.get("children"),function(e){e.render()}),this.center(),this.editable&&this.asEditable(),this},b.prototype.resize=function(e,t,n){},b.prototype.center=function(){var e=this.parent.wrapper.getABox(),t=this.wrapper.getABox();switch(this.position){case"center":this.attr("x",e.xCenter),this.attr("y",e.yMiddle);break;case"center-left":this.attr("x",e.x+this.xOffset+t.width/2),this.attr("y",e.yMiddle);if(this.image){var n=this.attr("x");this.attr({x:n+this.image.attr("width")})}break;case"center-right":this.attr("x",e.xRight-this.xOffset-t.width/2),this.attr("y",e.yMiddle);break;case"top-center":this.attr("x",e.xCenter),this.attr("y",e.y+t.height/2+this.yOffset);break;case"top-left":this.attr("x",e.x+t.width/2+this.xOffset),this.attr("y",e.y+t.height/2+this.yOffset);break;case"top-right":this.attr("x",e.xRight-this.xOffset-t.width/2),this.attr("y",e.y+t.height/2+this.yOffset);break;case"bottom-center":this.attr("x",e.xCenter),this.attr("y",e.yBottom-t.height/2-this.yOffset);break;case"bottom-left":this.attr("x",e.x+this.xOffset+t.width/2),this.attr("y",e.yBottom-t.height/2-this.yOffset);break;case"bottom-right":this.attr("x",e.x-this.xOffset-t.width/2),this.attr("y",e.yBottom-t.height/2-this.yOffset);break;default:}this.image&&(t=this.wrapper.getABox(),this.image.attr({x:t.x-this.image.attr("width")}),this.image.attr({y:t.y}))},b.prototype.setText=function(e){this.set("text",e),this.wrapper&&(this.wrapper.attr("text",e),this.center()),this.trigger("change:text",this)},b.prototype.getText=function(){return this.get("text")},b.prototype.remove=function(){this.image&&this.image.remove(),this.wrapper&&this.wrapper.remove()},b.prototype.asEditable=function(){var e=this;if(!e.wrapper)return;var t=function(e){var t=e.wrapper.getABox(),n=e.parent.wrapper.getABox(),r=e.diagram.el().offsetLeft,i=e.diagram.el().offsetTop,s=t.x+(isNaN(r)?0:r),o=t.y+(isNaN(i)?0:i),u=e.parent.attr("width"),a=20,f=this.textForm=document.createElement("form");f.setAttribute("style","position: absolute; left: "+s+"px; top: "+o+"px;");var l=document.createElement("input");return l.setAttribute("type","text"),l.value=e.get("text"),l.setAttribute("style","padding: 0; width:"+u+"px; height: "+a+"px; z-index: 1;"),f.appendChild(l),{form:f,input:l}},n=function(e){e&&e.parentNode&&e.parentNode.removeChild(e)};e.wrapper.dblclick(function(r){var i=e.diagram.modifiedLabel;i&&i!==e&&(n(e.diagram.inputText),n(e.diagram.modifiedLabel.textForm)),e.textForm&&n(e.textForm);var s=t(e);e.textForm=s.form,e.diagram.inputText=s.input,e.diagram.modifiedLabel=e,e.diagram.el().parentNode.appendChild(s.form)})};var w={createFigure:function(e,t,n){var r=e.paper(),i=e.figure,s=i.type,o;switch(s){case"rect":case"circle":case"ellipse":o=r[s](t,n);break;case"path":o=r.path(i.path);break;default:o=null}if(o){var u=e.parent,a,f;!i.width&&u&&(a=(u.wrapper?u.wrapper.attr("width"):i.width)-i.x,o.attr("width",a)),!i.height&&u&&(f=(u.wrapper?u.wrapper.attr("height"):i.height)-i.y,o.attr("height",f)),o.attr(e.get("attr"))}return o}},E=Diagram.Element.extend({_renderer:w,constructor:function(e){Diagram.Element.apply(this,[e]),this.parent=e.parent,delete e.parent,this.figure=_.clone(e),this.set("attr",_.clone(this.figure)),_.extend(this.get("attr"),this._attr(e)),this._initChildren()},render:function(){this.wrapper&&this.remove(!1);if(!this.diagram)throw new Error("Shape does not belong to a diagram");this.wrapper=this._renderer.createFigure(this,0,0);if(this.parent){var e=this.parent.wrapper,t=e.getABox();this.wrapper.translate(t.topLeft.x,t.topLeft.y)}return _.each(this.get("children"),function(e){e.render()}),this},remove:function(){_.each(this.get("children"),function(e){e.remove()}),this.wrapper&&this.wrapper.remove()},_initChildren:function(){var e=this.figure;if(e.figure){var t=e.figure;t.parent=this,this.get("children").push(new E(t))}}}),S=Diagram.Shape=Diagram.Element.extend({_renderer:w,connectable:!0,shadow:!1,resizable:!0,draggable:!0,toolbox:!0,constructor:function(e){e||(e={}),Diagram.Element.apply(this,[e]),this.inEdges=[],this.outEdges=[],!this.figure&&e.figure&&(this.figure=_.clone(e.figure)),this.parent=e.parent,this.set("type",this.type),this.set("id",e.id||_.uniqueId()),this.set("attr",_.clone(this.figure)),_.extend(this.get("attr"),this._attr(e)),this.diagram&&(this.diagram.get("children").push(this),this.diagram.trigger("add:children",this)),this._initChildren(),this.initialize.apply(this,arguments)},initialize:function(){},_initChildren:function(){var e=this.figure;if(e.label){var t=e.label;t.parent=this,this.get("children").push(new Diagram.Label(t))}if(e.compartment){var n=e.compartment;n.parent=this,this.get("children").push(new Diagram.Compartment(n))}if(e.figure){var r=e.figure;r.parent=this,this.get("children").push(new E(r))}},render:function(){this.wrapper&&this.remove(!1);if(!this.diagram)throw new Error("Shape does not belong to a diagram");this.wrapper=this._renderer.createFigure(this,this.get("attr").x,this.get("attr").y);if(this.parent){var e=this.parent.wrapper,t=e.getABox();this.wrapper.translate(t.topLeft.x,t.topLeft.y)}return this.wrapper.controller=this,this.draggable&&this.asDraggable(),this.toolbox&&(this._tool=new Diagram.ToolBox({element:this})),_.each(this.get("children"),function(e){e.render()}),this.wrapper.click(this.click),this.wrapper.mouseover(this.mouseover),this.wrapper.mouseout(this.mouseout),this},click:function(e){if(!this.controller)return;var t=this.controller,n=t.diagram;t.select(),t._tool&&t._tool.render();if(n.canConnect(t)){var r=n.connect(t);r&&r.render()}},mouseover:function(e){},mouseout:function(e){if(!this.controller)return;var t=this.controller;t._tool&&window.setTimeout(function(){t._tool&&(t._tool.isOver||t._tool.remove())},500)},remove:function(e){this.wrapper&&(this.wrapper.remove(),delete this.wrapper),_.each(this.get("children"),function(e){e.remove()}),_.each(this.inEdges,function(e){e.remove()}),_.each(this.outEdges,function(e){e.remove()}),this.shadow&&(this.shadowWrapper.remove(),delete this.shadowWrapper),this._tool&&(this._tool.remove(),delete this._tool)},disconnect:function(e){return this.inEdges=_.without(this.inEdges,e),this.outEdges=_.without(this.outEdges,e),this},startresize:function(){if(!this.wrapper)return;this.wrapper.oa=_.clone(this.wrapper.attrs),this._removeContent(),this.wrapper.attr({fill:"grey","fill-opacity":.2,"stroke-width":0})},resize:function(e,t,n){if(!this.wrapper)return;this.resizable&&(this.wrapper.attr(this.wrapper.rdxy(e,t,n)),this._renderEdges())},endresize:function(){C(this.wrapper),this._renderEdges(),this._renderContent()},toJSON:function(){var e=_.clone(this.attributes);return this.wrapper&&(e.attr=this.wrapper.attr()),e},asDraggable:function(e){return this.wrapper&&this.wrapper.attr({cursor:"move"}),this.wrapper.drag(T,x,N),this},toFront:function(){return this.wrapper.toFront()},startdragging:function(){if(!this.wrapper)return;var e=this.wrapper,t=_.clone(e.attrs),n=e.type;e.oa=t,e.oa.fill=e.attr("fill"),e.oa["fill-opacity"]===undefined&&(e.oa["fill-opacity"]=1),this._removeContent(),e.attr({fill:"grey","fill-opacity":.2,"stroke-width":0})},_removeContent:function(){_.each(this.get("children"),function(e){e.remove()})},_renderContent:function(){_.each(this.get("children"),function(e){e.render()})},_renderEdges:function(){var e=this.inEdges,t=this.outEdges;for(var n=0;n<e.length;n++)e[n].render();for(var r=0;r<t.length;r++)t[r].render()}});_.extend(Diagram.Shape.prototype,Diagram.Selectable,s);var k=Diagram.Compartment=Diagram.Shape.extend({resizable:!1,draggable:!1,layout:"fixed",spacing:5,constructor:function(e){Diagram.Shape.apply(this,[e]),e.layout&&(this.layout=e.layout),e.spacing&&(this.spacing=e.spacing),this.accepts=e.accepts||[],this.initialize.apply(this,arguments)},click:function(e){var t=this.controller;t.parent&&t.parent.select()},canCreate:function(e){if(!e||typeof e!="function")return!1;var t=_.find(this.accepts,function(t){return t===e});return t?!0:!1},createShape:function(e,t){var n={parent:this},r,i;this.layout==="vertical"?(n.x=0,n.y=this._height()):this.layout==="horizontal"?(n.x=this._width(),n.y=0):(r=t.x,i=t.y);var s=new e(n);return s&&this.get("children").push(s),s},_width:function(){var e=this.get("children"),t=0;return _.each(e,function(e){e.wrapper?t+=e.wrapper.attr("width"):t+=e.get("attr").width}),t},_height:function(){var e=this.get("children"),t=0;return _.each(e,function(e){e.wrapper?t+=e.wrapper.attr("height"):t+=e.get("attr").height}),t}}),L=function(e){return this.connection=e.connection,this.diagram=this.connection.diagram,this.attributes={},this};_.extend(L.prototype,Diagram.SVGElement.prototype),L.prototype.move=function(e){return this.x=e.x,this.y=e.y,this.wrapper&&this.wrapper.attr({x:this.x-2,y:this.y-2}),this},L.prototype.render=function(){if(this.wrapper)return this;var e=this.paper();return this.wrapper=e.rect(this.x-3,this.y-3,6,6),this.wrapper.attr({fill:"blue",stroke:"white"}),this.wrapper.anchor=this,this.asDraggable(),this},L.prototype.remove=function(){this.wrapper&&this.wrapper.remove()},L.prototype.asDraggable=function(){var e=function(e,t){this.attr({x:this.ox+e,y:this.oy+t}),this.anchor.connection.state="dragging",this.anchor.connection.dragger=this.anchor,this.anchor.connection.render()},t=function(){this.o(),this.anchor.shape.disconnect(this.anchor.connection)},n=function(){var e=this.paper,t=e.getElementsByPoint(this.attr("x"),this.attr("y")),n=_.find(t,function(e){return e!==this.anchor&&e.controller});n&&(this.anchor.shape=n.controller),this.anchor.connection.state=null;var r=this.anchor.connection.get("targetAnchor")===this.anchor;r?this.anchor.connection.connect(this.anchor.connection.get("sourceAnchor").shape,this.anchor.shape):this.anchor.connection.connect(this.anchor.shape,this.anchor.connection.get("targetAnchor").shape),this.anchor.connection.render()};return this.wrapper.drag(e,t,n),this},L.prototype.attach=function(e){return this.shape=e,this},L.prototype.toJSON=function(){return this.set("x",this.wrapper.x()),this.set("y",this.wrapper.y()),this._deepClone(this.attributes)};var A=function(e,t,n,r,i){this.paper=e,this.point=t,this.angle=n,this.radians=r,this.attributes={},this.attributes.attr={};if(i){this.attributes.type=i.type;var s=Raphael._availableAttrs;for(var o in i)_.has(s,o)&&(this.get("attr")[o]=i[o])}return this};_.extend(A.prototype,Diagram.Element.prototype,Diagram.SVGElement),A.prototype.remove=function(){this.wrapper&&this.wrapper.remove()},A.prototype.render=function(){var e=this.get("type");if(!e||e==="none")return this;var t;typeof Diagram.arrows[e]=="function"?t=Diagram.arrows[e](this.point):t=Diagram.arrows.basic(this.point);var n=this.point.x+ -2*(t.dx-1)*Math.cos(this.radians),r=this.point.y+2*(t.dy-1)*Math.sin(this.radians);return this.wrapper=this.paper.path(t.path.join(" ")),this.wrapper.attr(t.attr),this.wrapper.attr(this.get("attr")),this.wrapper.translate(n,r),this.wrapper.rotate(this.angle),this};var O=Diagram.ConnectionLabel=function(e){e||(e={});if(!e.connection)throw new Error("ConnectionLabel must have a parent Connection");return this.connection=e.connection,this.diagram=this.connection.diagram,this.position=e.position,this.attributes={},this.attributes.text=e.text,this.attributes.attr={},this};_.extend(O.prototype,Diagram.SVGElement.prototype,s),O.prototype.remove=function(){this.wrapper&&this.wrapper.remove()},O.prototype.render=function(){this.wrapper&&this.wrapper.remove();var e=this.paper(),t=this.connection,n=this.wrapper=e.text(0,0,this.get("text")),r=function(e,t,n,r){var i=t.xCenter<n,s=t.yMiddle>r,o=e.getBBox(),u=i?10+o.width/2:10-o.width,a=s?-10:10;return{x:n+u,y:r+a}},i=function(){var e=t.get("targetAnchor"),i=e.shape.wrapper.getABox(),s=e.wrapper.getABox(),o=s.xCenter,u=s.yMiddle,a=Math.sqrt(o*o+u*u),f=Math.atan(u/o);return r(n,i,o,u)},s=function(){var e=t.get("sourceAnchor"),i=e.shape.wrapper.getABox(),s=e.wrapper.getABox(),o=s.xCenter,u=s.yMiddle;return r(n,i,o,u)},o=function(){var e=t.get("sourceAnchor"),n=t.get("targetAnchor"),r=e.wrapper.getABox(),i=n.wrapper.getABox(),s=r.xCenter,o=r.yMiddle,u=i.xCenter,a=i.yMiddle,f=(s+u)/2,l=(o+a)/2;return l-=10,{x:f,y:l}},u;switch(this.position){case"start":u=s();break;case"end":u=i();break;default:u=o()}return this.wrapper.transform(["t",u.x,",",u.y].join("")),this.asEditable().asDraggable(),this},O.prototype.setText=function(e){this.set("text",e),this.wrapper&&this.wrapper.attr("text",e)},O.prototype.asDraggable=function(){var e=function(){this.o()},t=function(){},n=function(e,t,n,r,i){var s=this.ox+e,o=this.oy+t;this.attr({x:s,y:o})};return this.wrapper&&(this.wrapper.attr({cursor:"move"}),this.wrapper.drag(n,e,t)),this},O.prototype.asEditable=function(){var e=this,t=this.connection.diagram;if(!e.wrapper)return;var n=function(e){var t=e.wrapper.getABox(),n=e.connection.diagram,r=n.el().offsetLeft,i=n.el().offsetTop,s=t.x+(isNaN(r)?0:r),o=t.y+(isNaN(i)?0:i),u=t.width+20,a=20,f=document.createElement("form");f.setAttribute("style","position: absolute; left: "+s+"px; top: "+o+"px;");var l=document.createElement("input");return l.setAttribute("type","text"),l.setAttribute("placeholder",e.wrapper.attr("text")),l.setAttribute("style","padding: 0; width:"+u+"px; height: "+a+"px; z-index: 1;"),f.appendChild(l),{form:f,input:l}},r=function(e){e&&e.parentNode&&e.parentNode.removeChild(e)};return e.wrapper.dblclick(function(i){var s=t.modifiedLabel;s&&s!==e&&(r(t.inputText),r(t.modifiedLabel.textForm)),e.textForm&&r(e.textForm);var o=n(e);e.textForm=o.form,t.inputText=o.input,t.modifiedLabel=e,t.el().parentNode.appendChild(o.form)}),this};var M=Diagram.Connection=Diagram.DiagramElement.extend({constructor:function(e){c.DiagramElement.apply(this,[e]),this.set("sourceAnchor",new L({connection:this})),this.set("targetAnchor",new L({connection:this})),this.vertices=[],this.initialize.apply(this,arguments)},initialize:function(){},remove:function(){return this.wrapper&&this.wrapper.remove(),this.dummy&&this.dummy.remove(),this},render:function(){var e=this._boxes(),t=e[0],r=e[1],i=this._points(t,r),s=i[0],o=i[1],u,a,f;if(!s||!o)return this;this.remove(),u=P(t.center,r.center),a=360-u.degrees+180,f=360-u.degrees;var l=D(s,o,this.vertices,!1);return this.wrapper=this.paper().path(l.join(" ")),this.has("attr")&&this.wrapper.attr(this.get("attr")),this.get("sourceAnchor").move(srcPoint).render().hide(),this.get("targetAnchor").move(tgtPoint).render().hide(),this.dummy=new n(paper,srcPoint,tgtPoint),this.dummy.attr({opacity:0,"stroke-width":12}),this},connect:function(e,t){return!e||!t?this:(this.set("source",e),this.set("target",t),this.get("sourceAnchor").attach(e),this.get("targetAnchor").attach(t),e.trigger("connect:source",this),t.trigger("connect:target",this),e.outEdges.push(this),t.inEdges.push(this),this)},disconnect:function(){var e=this.get("source"),t=this.get("target");return e&&(e.outEdges=_.reject(e.outEdges,function(e){return e===this},this)),t&&(t.inEdges=_.reject(t.inEdges,function(e){return e===this},this)),this.set("source",null),this.set("target",null),this},toJSON:function(){var e={};return e.source=this.get("source").get("id"),e.target=this.get("target").get("id"),e.type=this.get("type"),e.id=this.get("id"),e.sourceAnchor=this.get("sourceAnchor"),e.targetAnchor=this.get("targetAnchor"),e.x=this.get("x"),e.y=this.get("y"),this.wrapper&&(e.attr=this.wrapper.attr()),e},_boxes:function(){var e=this.paper(),t,n;return this.state&&this.state==="dragging"?this.dragger===this.get("sourceAnchor")?(t=this.get("sourceAnchor").wrapper.getABox(),n=this.get("target").wrapper.getABox()):(t=this.get("source").wrapper.getABox(),n=this.get("targetAnchor").wrapper.getABox()):(t=this.get("source").wrapper.getABox(),n=this.get("target").wrapper.getABox()),[t,n]},_points:function(e,t){var r=new n(paper,e.center,t.center),i,s;return i=r.findIntersection(e),s=r.findIntersection(t),r.remove(),[i,s]},_ends:function(){}});_.extend(Diagram.Connection.prototype,s);var H=Diagram.Palette=function(e){this.diagram=e,this.paletteX=10,this.paletteY=10};H.extend=a,H.prototype.render=function(){if(this.element)return this;var e=this.diagram;this.element=document.createElement("div"),this.element.setAttribute("class","palette"),this.element.style.left=this.paletteX,this.element.style.top=this.paletteY;var t=document.createElement("div");t.setAttribute("class","palette-inner"),this.header=document.createElement("div"),this.header.setAttribute("class","palette-header");var n=document.createElement("div"),r=document.createElement("a");r.innerHTML=" +";var i=document.createElement("a");return i.innerHTML=" -",r.addEventListener("click",function(){e.zoom("in")}),i.addEventListener("click",function(){e.zoom("out")}),n.appendChild(r),n.appendChild(i),this.header.appendChild(n),this.body=document.createElement("div"),this.body.setAttribute("class","palette-body"),_.each(this.groups,function(e){var t=new B(e,this);t.render(),this.body.appendChild(t.el())},this),this.element.appendChild(t),t.appendChild(this.header),t.appendChild(this.body),this.diagram.el().appendChild(this.element),this},H.prototype.el=function(){return this.element},H.prototype.asDraggable=function(){if(this.element&&this.header){this.header.style.cursor="move";var e=this;this.header.addEventListener("mousedown",function(t){function n(t){var n=e.element.style.position;e.element.style.position="absolute",e.element.style.left=t.clientX+window.pageXOffset-e.innerX+"px",e.element.style.top=t.clientY+window.pageYOffset-e.innerY+"px",e.element.style.position=n}e.innerX=t.clientX+window.pageXOffset-e.element.offsetLeft,e.innerY=t.clientY+window.pageYOffset-e.element.offsetTop,window.addEventListener("mousemove",n,!1),window.addEventListener("mouseup",function(){window.removeEventListener("mousemove",n,!1)},!0)})}},H.prototype.remove=function(){this.element&&(this.element.parentNode.removeChild(this.element),this.element=null)};var B=function(e,t){this.title=e.title,this.tools=e.tools,this.palette=t,this.views=[]};B.prototype.template=_.template('<div class="palette-header"><span> <%= title %></span></div><div class="palette-body"></div>'),B.prototype.render=function(){function r(e,t){var n;if(!e)return;return typeof e.canCreate=="function"&&e.canCreate(t)&&(n=e),n||(n=_.find(e.get("children"),function(e){return r(e,t)!==undefined})),n}function i(s){var o=n.palette.currentItem,u,a;if(o){u=t.getMousePosition(e._paper,s);if(typeof o.shape=="function")if(e._canCreate(n.palette.currentItem.shape))a=e.createShape(o.shape,u);else{var f=e.paper().getElementsByPoint(u.x,u.y);if(f&&f.length){var l=f.length,c=0,h,p,d;while(c<l&&!h)p=f[c],d=p.controller,h=r(d,o.shape),c++;h&&(a=h.createShape(o.shape,u))}}a&&a.render(),n.palette.currentItem.trigger("created")}e.el().removeEventListener("click",i,!1)}this.remove(),this.element=document.createElement("div"),this.element.setAttribute("class","palette-group"),this.element.innerHTML=this.template(this),this.header=this.element.children[0],this.body=this.element.children[1],_.each(this.tools,function(t){var n=new j(t,this.palette);n.render(),n.on("click",function(){this.palette.currentItem=n,typeof n.edge=="function"?e.currentEdge=n.edge:e.el().addEventListener("click",i,!1)},this),n.on("created",function(){this.palette.currentItem=null},this),this.views.push(n),this.body.appendChild(n.el())},this);var e=this.palette.diagram,n=this;return this.header.addEventListener("click",function(e){n._hidden?(n.show(),n._hidden=!1):(n.hide(),n._hidden=!0)}),this},B.prototype.el=function(){return this.element},B.prototype.hide=function(){return _.each(this.views,function(e){e.remove()}),this},B.prototype.show=function(){return _.each(this.views,function(e){e.render(),this.body.appendChild(e.el())},this),this},B.prototype.remove=function(){return this.element&&this.element.parentNode.removeChild(this.element),this};var j=function(e,t){this.icon=e.icon||"icon-tool-"+e.title,this.title=e.title,this.shape=e.shape,this.edge=e.edge,this.palette=t};_.extend(j.prototype,s),j.prototype.template=_.template('<span><i class="<%= icon %>"></i> <%= title %></span>'),j.prototype.render=function(){this.remove(),this.element=document.createElement("div"),this.element.setAttribute("class","palette-item");var e=this.template(this);this.element.innerHTML=e;var t=this;return t.element.addEventListener("click",function(e){e.stopPropagation(),t.trigger("click")},!1),this.element.addEventListener("mouseover",function(e){t.element.setAttribute("class","palette-item highlight")}),this.element.addEventListener("mouseout",function(e){t.element.setAttribute("class","palette-item")}),this},j.prototype.remove=function(){this.element&&(this.element.parentNode.removeChild(this.element),delete this.element)},j.prototype.el=function(){return this.element};var F=Diagram.PropertyBox=function(e){return e||(e={}),this.diagram=e.diagram,this.x=e.x,this.y=e.y,this.width=e.width?e.width:340,this.height=e.height?e.height:200,this};F.prototype.render=function(){if(this.root)return this;this.root=document.createElement("div"),this.root.setAttribute("class","property-box"),this.header=document.createElement("div"),this.header.setAttribute("class","property-box-header"),this.body=document.createElement("div"),this.body.setAttribute("class","property-box-body"),this.root.appendChild(this.header),this.root.appendChild(this.body);var e=document.createElement("a");e.setAttribute("style","position: relative; font-size: 12px; color: black;"),e.style.left=this.width-16+"px",e.style.cursor="default",e.innerHTML="X",this.header.appendChild(e);var t=this;return e.addEventListener("click",function(e){t.remove()}),typeof F.bodyTemplate=="function"&&(this.body.innerHTML=F.bodyTemplate()),this.root.style.left=this.x+"px",this.root.style.top=this.y+"px",this.diagram.el().appendChild(this.root),this.asDraggable(),this},F.prototype.asDraggable=function(){if(this.root){this.header.style.cursor="move";var e=this;e._moving=!1,this.header.addEventListener("mousedown",function(t){e._moving=!0,e.offsetX=t.pageX-e.x,e.offsetY=t.pageY-e.y}),this.diagram.el().addEventListener("mouseup",function(t){e._moving=!1}),this.diagram.el().addEventListener("mousemove",function(t){e._moving&&(e.x=t.pageX-e.offsetX,e.y=t.pageY-e.offsetY,e.root.style.left=e.x+"px",e.root.style.top=e.y+"px")})}},F.prototype.remove=function(){this.root&&(this.diagram.el().removeChild(this.root),this.root=null)},Diagram.ToolBox.propertyBox=F})();